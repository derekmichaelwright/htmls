---
title: "ANOVA Vignette"
subtitle: "A tutorial on how running an ANOVA in R"
summary:  "A tutorial on how running an ANOVA in R"
author: "Derek Michael Wright <derek.wright@usask.com> [www.dblogr.com/](https://dblogr.netlify.com/)"
date: "2020-03-02"
categories: [ "Academic" ]
tags: [ "Academic", "Tutorials" ]
draft: true
image:
  preview_only: true
links: 
  - icon_pack: fas
    icon: chart-line
    name: All Graphs
    url: academic_graphs/anova
  - icon: file-code
    icon_pack: far
    name: HTML
    url: https://derekmichaelwright.github.io/htmls/academic/anova.html
  - icon_pack: far
    icon: file-pdf
    name: PDF (Save/Print)
    url: academic_pdfs/anova.pdf
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, fig.align="center")
```

---

# Definitions

**Fixed Variable**: a non-random variable. 

- *e.g.*, in an experiment testing the effect of fertilizer on yield, the *fertilizer level* treatment is a fixed variable.

**Random Variable**: a variable whose values depend on outcomes of a random phenomenon. 

- *e.g.*, if our experiment testing fertilizer effect on yield was conducted over a number of years at the same site, *year* would be a random variable. 

**Fixed Effects Model**: group means are fixed (non-random).

**Random Effects Model**: group means are a random sample from a population.

**Mixed Model**: a statistical model containing both fixed and random effects.

**Analysis of Variance (ANOVA)**: a collection of statistical models and their associated estimation procedures (such as the "variation" among and between groups) used to analyze the differences among group means in a sample. An ANOVA provides a statistical test of whether two or more population means are equal. essentially, it's a *t*-test for when you want to compare more than two means.

\pagebreak

# Prepare Data

```{r}
# devtools::install_github("derekmichaelwright/dblogr")
library(dblogr) # Loads: tidyverse, ggpubr, ggbeeswarm, ggrepel
library(lme4)
```

```{r}
pca <- read.csv("data_pca_results.csv")
rr <- read.csv("data_raw.csv") %>% 
  left_join(select(pca, Name, Cluster)) %>% 
  mutate(Name = factor(Name), Cluster = factor(Cluster), 
         Rep = factor(Rep), Year = factor(Year),
         VEG = DTF - DTE) %>%
  filter(!is.na(DTF))
```

# One-way ANOVA

**One-way ANOVA**: used when you have one nominal variable (groups), and one measurement variable.

- *e.g.*, we have 324 genotypes categoriszed into 8 cluster groups, and want to test if these cluster groups are significantly different for days to flower (DTF) in the 2017 field trail in Sutherland, Canada. 

$$DTF = \mu + Cluster_i + error_i$$

```{r}
# Prep data
xx <- rr %>% filter(Location == "Sutherland, Canada", Year == 2017)
# Run ANOVA
model <- lm(DTF ~ Cluster, data = xx) 
anova(model)
```

**Interpretation**: p value < 0.05 = at least one of the cluster groups has a mean DTF which is significantly different from the other cluster groups. 

However, the fact that at least one of the cluster groups is different from the rest, isn't very useful. What we may actually want to know, is which ones are different from eachother. To do this, we will need to perform multiple comparisons. but first, lets visualize the data:

\pagebreak

```{r}
# Prep data
means <- xx %>% group_by(Cluster) %>% summarise(DTF = mean(DTF))
colors <- c("darkred",   "darkorange3", "darkgoldenrod2", "deeppink3", 
            "steelblue", "darkorchid4", "cornsilk4",      "darkgreen")
# Plot
ggplot(xx, aes(x = Cluster, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = "red", size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  theme_dblogr(legend.position = "none") +
  labs(title = "Sutherland, Canada 2017")
```

Looking at the data, groups 1 - 2, 4 - 5, and 3 - 7 are the only ones which look like they may **NOT** be significantly different from eachother.

\pagebreak

```{r}
pairwise.t.test(xx$DTF, xx$Cluster, p.adj = "none")
model <- lm(DTF ~ Cluster, data = xx %>% filter(Cluster %in% c(1,2))) 
anova(model)
t.test(xx$DTF[xx$Cluster==1], xx$DTF[xx$Cluster==2])
```

Pairwise *t*-tests show that groups 1 - 2 are the only non-significant pair. However, using a p value of 0.05 indicates that there will be a 5% chance of obtaining a false positive with each test. Multiply this across many pairwise comparisions (tests) and the chances of obtaining false positives increases. In other words, statistical speaking, if one was using compltely random data, for every 20 tests you perform, 1 will be a false positive. Since we just did 28 tests, we can assume at least one might be a false positive. Another way to think of how problematic this is: based on the number of tests we performed, there is almost a garuntee that one test will be significant simply due to the randomness of data.

Luckily, there are a number of statistical approaches to deal with this:

- [Bonfferoni](https://en.wikipedia.org/wiki/Bonferroni_correction)
- [Holm](https://en.wikipedia.org/wiki/Holm%E2%80%93Bonferroni_method)
- [TukeyHSD](https://en.wikipedia.org/wiki/Tukey%27s_range_test)

```{r}
x<- pairwise.t.test(xx$DTF, xx$Cluster, p.adj = "none")
# Adjust p values using different methods
pAdj <- function(x) {
  as.data.frame(x[[3]]) %>% gather("Group", "p.value", 1:ncol(.)) %>% 
    mutate(Group = paste(2:8, Group, sep = "-"),
           p.value = round(p.value, 5)) %>% 
    filter(!is.na(p.value))
}
p1 <- pAdj(pairwise.t.test(xx$DTF, xx$Cluster, p.adj = "none"))
p2 <- pAdj(pairwise.t.test(xx$DTF, xx$Cluster, p.adj = "bonf")) %>% rename(bonf=p.value)
p3 <- pAdj(pairwise.t.test(xx$DTF, xx$Cluster, p.adj = "holm")) %>% rename(holm=p.value)
p4 <- TukeyHSD(aov(model))[[1]] %>% as.data.frame() %>% rownames_to_column("Group") %>%
  rename(TukeyHSD=`p adj`) %>% select(Group, TukeyHSD) %>%
  mutate(TukeyHSD = round(TukeyHSD, 5))
pp <- left_join(p1, p2, by = "Group") %>%
  left_join(p3, by = "Group") %>%
  left_join(p4, by = "Group") %>%
  filter(Group %in% c("2-1", "5-4", "7-3"))
pp
```


```{r eval = F, echo = F}
library(multcomp)
mc <- glht(model, mcp(Cluster = "Tukey"))
cld(summary(mc, test = adjusted("bonferroni")))
#
LSD.test(model, "Cluster", console = T) # https://support.minitab.com/en-us/minitab/18/help-and-how-to/modeling-statistics/anova/supporting-topics/multiple-comparisons/what-is-fisher-s-lsd-method/
```

```{r}
library(agricolae)
HSD.test(model, "Cluster", console = T)
```

Now lets do another with Rep. Unless there is variability within our field, this should be non-significant.

$$DTF = \mu + Cluster_i + error_i$$

```{r}
model <- lm(DTF ~ Rep, data = xx) 
anova(model)
pairwise.t.test(xx$DTF, xx$Rep, p.adj = "bonf")
```

Rep 1 is significantly different from Rep 2 & 3.

```{r}
# Plot
means <- xx %>% group_by(Rep) %>% summarise(DTF = mean(DTF))
ggplot(xx, aes(x = Rep, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = "red", size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  labs(title = "Sutherland, Canada 2017")
```

Looking at the data, Rep 1 does seem slightly different from Rep 2 and 3.

Now let try another year - 2018:

```{r}
# Prep data
xx <- rr %>% filter(Location == "Sutherland, Canada", Year == 2018)
# Run ANOVA
model <- lm(DTF ~ Rep, data = xx) 
anova(model)
```

For this location, the Reps are not significantly different, and in fact look equal when we plot the data.

```{r}
# Plot
means <- xx %>% group_by(Rep) %>% summarise(DTF = mean(DTF))
ggplot(xx, aes(x = Rep, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = "red", size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  labs(title = "Sutherland, Canada 2018")
```

\pagebreak

# Two-way ANOVA

**Two-way ANOVA**: used when

```{r}
model <- lm(DTF ~ Cluster + Rep, data = xx) 
anova(model)
```

Now lets add an interaction term

```{r}
model <- lm(DTF ~ Cluster + Rep + Cluster:Rep, data = xx) 
anova(model)
```

is the same as

```{r}
model <- lm(DTF ~ Cluster * Rep, data = xx) 
anova(model)
```


```{r}
# Prep data
locs <- c("Sutherland, Canada", "Rosthern, Canada")
xx <- rr %>% filter(Location %in% locs, Cluster == 4:5)
# Run ANOVA
model <- lm(VEG ~ Year * Cluster, data = xx) 
anova(model)
```

```{r}
# Prep data
locs <- c("Sutherland, Canada", "Rosthern, Canada")
xx <- rr %>% filter(Location %in% locs, Cluster == 7:8)
# Run ANOVA
model <- lm(VEG ~ Year * Cluster, data = xx) 
anova(model)
```

```{r}
# Prep data
locs <- c("Sutherland, Canada", "Rosthern, Canada")
xx <- rr %>% filter(Location %in% locs, Cluster == 7:8)
# Run ANOVA
model <- lm(VEG ~ Year * Cluster, data = xx) 
anova(model)
model <- lmer(VEG ~ Year * Cluster + (1|Year/Rep), data = xx) 
anova(model)
```


```{r}
# Prep data
xx <- rr %>% filter(Location == "Sutherland, Canada")
means <- xx %>% group_by(Year) %>% summarise(DTF = mean(DTF))
# Plot
ggplot(xx, aes(x = Year, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = "red", size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  labs(title = "Sutherland, Canada")
#
model <- lm(DTF ~ Year, data = xx) 
anova(model)
pairwise.t.test(xx$DTF, xx$Year, p.adj = "bonf")
#
xx <- rr %>% filter(Location == "Sutherland, Canada")
model <- lmer(DTF ~ Name + Year + (1 | Rep), data = xx)
anova(model)
```

... To Be Continued ...

```{r echo = F, eval = F}
my_comp <- list( c(1, 2), c(4,5))
means <- xx %>% group_by(Cluster) %>% summarise(DTF = mean(DTF))
library(ggpubr)
ggplot(xx, aes(x = Cluster, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = "red", size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  stat_compare_means(comparisons = my_comp, label = "p.signif")
#
# pwr::pwr.anova.test(k = 8, n = NULL, f = 2, sig.level = 0.05)
```


```{r eval = F, echo = F}
xx <- xx %>% filter(Cluster == "2")
model <- lm(DTF ~ Name, data = xx)
anova(model)
```

**Interpretation**: p value > 0.05 = There is no significant difference for DTF among the genotypes within cluster group 2.

```{r eval = F, echo = F}
xx <- rr %>% filter(Location == "Sutherland, Canada")
xm <- xx %>% group_by(Year) %>% summarise(DTF = mean(DTF))
ggplot(xx, aes(x = Year, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = xm, fill = "red", size = 4, pch = 21) +
  scale_color_manual(values = colors)
model <- lm(DTF ~ Year, data = xx)
anova(model)
#
xx <- xx %>% filter(Year != 2018)
model <- lm(DTF ~ Year, data = xx)
anova(model)
```

```{r eval = F, echo = F}
model <- lm(DTF ~ Year + Rep, data = xx)
anova(model)
#

my_comp <- list( c(1, 2), c(2, 3), c(1, 3) )
xm <- xx %>% group_by(Year, Rep) %>% summarise(DTF = mean(DTF))
ggplot(xx, aes(x = Rep, y = DTF, color = Rep)) +
  geom_quasirandom() +
  stat_compare_means(comparisons = my_comp, label = "p.signif") +
  facet_grid(.~Year) #+
  #scale_color_manual(values = colors)
#
library(multcomp)
mc <- glht(model, mcp(Location = "Tukey"))
mc <- multcomp::glht(model)
summary(mc, test = multcomp::adjusted("single-step"))
summary(mc)
```


```{r eval = F, echo = F}
model <- lmer(DTF ~ Name + Location + Year + (1 | Year/Rep), data = rr)
anova(model)

#
model <- lmer(DTF ~ Expt + (1 | Rep), data = rr)
anova(model)
#summary(aov(model))
model <- lmer(DTF ~ Name + (1 | Year), data = xx)

#
#model <- lm(DTF ~ Name, data = r1)
#anova(model)

```


# Nepal

y ~ x1*x2 + (1|x2/r1/b1)

```{r eval = F, echo = F}
# Prep data
xx <- rr %>% filter(Location == "Bardiya, Nepal")
#
model <- lmer(DTF ~ Name + Year + (1|Year/Rep), data = xx) 
anova(model)
```

```{r eval = F, echo = F}
# Prep data
xx <- rr %>% filter(Location == "Bardiya, Nepal") %>%
  mutate(YearCluster = paste(Year, Cluster, sep = "-"))
means <- xx %>% group_by(YearCluster) %>% summarise(DTF = mean(DTF))
# Make color palette
colors <- c("darkred",   "darkorange3", "darkgoldenrod2", "deeppink3", 
            "steelblue", "darkorchid4", "cornsilk4",      "darkgreen")
# Plot
ggplot(xx, aes(x = YearCluster, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = "red", size = 4, pch = 21) +
  scale_color_manual(values = colors)
```

Now, lets run the One-way ANOVA:

```{r eval = F, echo = F}
model <- lm(DTF ~ YearCluster, data = xx) 
anova(model)
```

```{r eval = F, echo = F}
pairwise.t.test(xx$DTF, xx$YearCluster, p.adj = "none")
```

```{r eval = F, echo = F}
x<-pairwise.t.test(xx$DTF, xx$YearCluster, p.adj = "none")
pfunct <- function(x) {
  as.data.frame(x[[3]]) %>% rownames_to_column("Group1") %>%
    gather("Group", "p.value", 2:ncol(.)) %>% 
    mutate(Group = paste(Group, Group1, sep = " - "),
           p.value = round(p.value, 5)) %>% 
    filter(!is.na(p.value))
}
#
p1 <- pfunct(pairwise.t.test(xx$DTF, xx$YearCluster, p.adj = "none"))
p2 <- pfunct(pairwise.t.test(xx$DTF, xx$YearCluster, p.adj = "bonf")) %>% rename(bonf=p.value)
p3 <- pfunct(pairwise.t.test(xx$DTF, xx$YearCluster, p.adj = "holm")) %>% rename(holm=p.value)
p4 <- TukeyHSD(aov(model))[[1]] %>% as.data.frame() %>% rownames_to_column("Group") %>%
  rename(TukeyHSD=`p adj`) %>% select(Group, TukeyHSD)
pp <- left_join(p1, p2, by = "Group") %>%
  left_join(p3, by = "Group") %>%
  filter(Group %in% c("1 - 2", "4 - 5", "3 - 7"))
pp
#
library(multcomp)
mc <- glht(model, mcp(Cluster = "Tukey"))
cld(summary(mc, test = adjusted("bonferroni")))
```


```{r eval = F, echo = F}

summary(aov(lm(DTF ~ Location * Year, data = rr)))
summary(aov(lm(DTF ~ Name * Expt, data = rr)))
anova(lmer(DTF ~ Location + Year + (1|Year/Rep), data = rr))
summary(lmer(DTF ~ Location + Year + (1|Year/Rep), data = rr))
lmer(DTF ~ Location * Year + (1|Year/Rep), data = rr)
lmer(DTF ~ Location * Year, data = rr)
#
r1 <- rr %>% filter(Expt == "Sutherland, Canada 2018")
summary(aov(lm(DTF ~ Rep + Name, data = r1)))
summary(aov(lm(DTF ~ Rep + Name + Rep:Name, data = r1)))
summary(aov(lm(DTF ~ Rep * Name, data = r1)))
summary(aov(lm(DTF ~ 0 + Rep + Name, data = r1)))
anova(lmer(DTF ~ 0 + (1|Rep) + Entry, data = r1))
anova(lmer(DTF ~ 0 + (1|Rep) + (1|Entry, data = r1))
summary(aov(lm(DTF ~ 0 + Rep + Entry, data = r1)))

```

---

&copy; Derek Michael Wright 2020 [www.dblogr.com/](https://dblogr.netlify.com/)
