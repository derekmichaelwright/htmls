---
title: "ANOVA Vignette"
subtitle: "A tutorial on how running an ANOVA in R"
summary:  "A tutorial on how running an ANOVA in R"
author: "Derek Michael Wright <derek.wright@usask.com> [www.dblogr.com/](https://dblogr.netlify.com/)"
date: "2020-03-02"
categories: [ "Academic" ]
tags: [ "Academic", "Tutorials" ]
draft: true
image:
  preview_only: true
links: 
  - icon_pack: fas
    icon: chart-line
    name: All Graphs
    url: academic_graphs/anova
  - icon: file-code
    icon_pack: far
    name: HTML
    url: https://derekmichaelwright.github.io/htmls/academic/anova.html
  - icon_pack: far
    icon: file-pdf
    name: PDF (Save/Print)
    url: academic_pdfs/anova.pdf
---



<hr />
<div id="definitions" class="section level1">
<h1>Definitions</h1>
<p><strong>Fixed Variable</strong>: a non-random variable.</p>
<ul>
<li><em>e.g.</em>, in an experiment testing the effect of fertilizer on yield, the <em>fertilizer level</em> treatment is a fixed variable.</li>
</ul>
<p><strong>Random Variable</strong>: a variable whose values depend on outcomes of a random phenomenon.</p>
<ul>
<li><em>e.g.</em>, if our experiment testing fertilizer effect on yield was conducted over a number of years at the same site, <em>year</em> would be a random variable.</li>
</ul>
<p><strong>Fixed Effects Model</strong>: group means are fixed (non-random).</p>
<p><strong>Random Effects Model</strong>: group means are a random sample from a population.</p>
<p><strong>Mixed Model</strong>: a statistical model containing both fixed and random effects.</p>
<p><strong>Analysis of Variance (ANOVA)</strong>: a collection of statistical models and their associated estimation procedures (such as the “variation” among and between groups) used to analyze the differences among group means in a sample. An ANOVA provides a statistical test of whether two or more population means are equal. essentially, it’s a <em>t</em>-test for when you want to compare more than two means.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="prepare-data" class="section level1">
<h1>Prepare Data</h1>
<pre class="r"><code># devtools::install_github(&quot;derekmichaelwright/dblogr&quot;)
library(dblogr) # Loads: tidyverse, ggpubr, ggbeeswarm, ggrepel
library(lme4)</code></pre>
<pre class="r"><code>pca &lt;- read.csv(&quot;data_pca_results.csv&quot;)
rr &lt;- read.csv(&quot;data_raw.csv&quot;) %&gt;% 
  left_join(select(pca, Name, Cluster)) %&gt;% 
  mutate(Name = factor(Name), Cluster = factor(Cluster), 
         Rep = factor(Rep), Year = factor(Year),
         VEG = DTF - DTE) %&gt;%
  filter(!is.na(DTF))</code></pre>
</div>
<div id="one-way-anova" class="section level1">
<h1>One-way ANOVA</h1>
<p><strong>One-way ANOVA</strong>: used when you have one nominal variable (groups), and one measurement variable.</p>
<ul>
<li><em>e.g.</em>, we have 324 genotypes categoriszed into 8 cluster groups, and want to test if these cluster groups are significantly different for days to flower (DTF) in the 2017 field trail in Sutherland, Canada.</li>
</ul>
<p><span class="math display">\[DTF = \mu + Cluster_i + error_i\]</span></p>
<pre class="r"><code># Prep data
xx &lt;- rr %&gt;% filter(Location == &quot;Sutherland, Canada&quot;, Year == 2017)
# Run ANOVA
model &lt;- lm(DTF ~ Cluster, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: DTF
##            Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
## Cluster     7 17220.0 2460.00  469.24 &lt; 2.2e-16 ***
## Residuals 937  4912.3    5.24                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p><strong>Interpretation</strong>: p value &lt; 0.05 = at least one of the cluster groups has a mean DTF which is significantly different from the other cluster groups.</p>
<p>However, the fact that at least one of the cluster groups is different from the rest, isn’t very useful. What we may actually want to know, is which ones are different from eachother. To do this, we will need to perform multiple comparisons. but first, lets visualize the data:</p>
<div style="page-break-after: always;"></div>
<pre class="r"><code># Prep data
means &lt;- xx %&gt;% group_by(Cluster) %&gt;% summarise(DTF = mean(DTF))
colors &lt;- c(&quot;darkred&quot;,   &quot;darkorange3&quot;, &quot;darkgoldenrod2&quot;, &quot;deeppink3&quot;, 
            &quot;steelblue&quot;, &quot;darkorchid4&quot;, &quot;cornsilk4&quot;,      &quot;darkgreen&quot;)
# Plot
ggplot(xx, aes(x = Cluster, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = &quot;red&quot;, size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  theme_dblogr(legend.position = &quot;none&quot;) +
  labs(title = &quot;Sutherland, Canada 2017&quot;)</code></pre>
<p><img src="/academic_posts/anova/index_files/figure-html/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Looking at the data, groups 1 - 2, 4 - 5, and 3 - 7 are the only ones which look like they may <strong>NOT</strong> be significantly different from eachother.</p>
<div style="page-break-after: always;"></div>
<pre class="r"><code>pairwise.t.test(xx$DTF, xx$Cluster, p.adj = &quot;none&quot;)</code></pre>
<pre><code>## 
##  Pairwise comparisons using t tests with pooled SD 
## 
## data:  xx$DTF and xx$Cluster 
## 
##   1       2       3       4       5       6       7      
## 2 0.1471  -       -       -       -       -       -      
## 3 &lt; 2e-16 &lt; 2e-16 -       -       -       -       -      
## 4 &lt; 2e-16 &lt; 2e-16 &lt; 2e-16 -       -       -       -      
## 5 &lt; 2e-16 &lt; 2e-16 &lt; 2e-16 0.0064  -       -       -      
## 6 &lt; 2e-16 &lt; 2e-16 2.5e-08 &lt; 2e-16 &lt; 2e-16 -       -      
## 7 &lt; 2e-16 &lt; 2e-16 3.1e-05 &lt; 2e-16 &lt; 2e-16 &lt; 2e-16 -      
## 8 &lt; 2e-16 &lt; 2e-16 &lt; 2e-16 &lt; 2e-16 &lt; 2e-16 &lt; 2e-16 &lt; 2e-16
## 
## P value adjustment method: none</code></pre>
<pre class="r"><code>model &lt;- lm(DTF ~ Cluster, data = xx %&gt;% filter(Cluster %in% c(1,2))) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: DTF
##            Df  Sum Sq Mean Sq F value Pr(&gt;F)
## Cluster     1   11.04 11.0381  1.6849 0.1957
## Residuals 214 1401.96  6.5512</code></pre>
<pre class="r"><code>t.test(xx$DTF[xx$Cluster==1], xx$DTF[xx$Cluster==2])</code></pre>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  xx$DTF[xx$Cluster == 1] and xx$DTF[xx$Cluster == 2]
## t = -1.134, df = 90.992, p-value = 0.2598
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.3622435  0.3721119
## sample estimates:
## mean of x mean of y 
##  43.90625  44.40132</code></pre>
<p>Pairwise <em>t</em>-tests show that groups 1 - 2 are the only non-significant pair. However, using a p value of 0.05 indicates that there will be a 5% chance of obtaining a false positive with each test. Multiply this across many pairwise comparisions (tests) and the chances of obtaining false positives increases. In other words, statistical speaking, if one was using compltely random data, for every 20 tests you perform, 1 will be a false positive. Since we just did 28 tests, we can assume at least one might be a false positive. Another way to think of how problematic this is: based on the number of tests we performed, there is almost a garuntee that one test will be significant simply due to the randomness of data.</p>
<p>Luckily, there are a number of statistical approaches to deal with this:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Bonferroni_correction">Bonfferoni</a></li>
<li><a href="https://en.wikipedia.org/wiki/Holm%E2%80%93Bonferroni_method">Holm</a></li>
<li><a href="https://en.wikipedia.org/wiki/Tukey%27s_range_test">TukeyHSD</a></li>
</ul>
<pre class="r"><code>x&lt;- pairwise.t.test(xx$DTF, xx$Cluster, p.adj = &quot;none&quot;)
# Adjust p values using different methods
pAdj &lt;- function(x) {
  as.data.frame(x[[3]]) %&gt;% gather(&quot;Group&quot;, &quot;p.value&quot;, 1:ncol(.)) %&gt;% 
    mutate(Group = paste(2:8, Group, sep = &quot;-&quot;),
           p.value = round(p.value, 5)) %&gt;% 
    filter(!is.na(p.value))
}
p1 &lt;- pAdj(pairwise.t.test(xx$DTF, xx$Cluster, p.adj = &quot;none&quot;))
p2 &lt;- pAdj(pairwise.t.test(xx$DTF, xx$Cluster, p.adj = &quot;bonf&quot;)) %&gt;% rename(bonf=p.value)
p3 &lt;- pAdj(pairwise.t.test(xx$DTF, xx$Cluster, p.adj = &quot;holm&quot;)) %&gt;% rename(holm=p.value)
p4 &lt;- TukeyHSD(aov(model))[[1]] %&gt;% as.data.frame() %&gt;% rownames_to_column(&quot;Group&quot;) %&gt;%
  rename(TukeyHSD=`p adj`) %&gt;% select(Group, TukeyHSD) %&gt;%
  mutate(TukeyHSD = round(TukeyHSD, 5))
pp &lt;- left_join(p1, p2, by = &quot;Group&quot;) %&gt;%
  left_join(p3, by = &quot;Group&quot;) %&gt;%
  left_join(p4, by = &quot;Group&quot;) %&gt;%
  filter(Group %in% c(&quot;2-1&quot;, &quot;5-4&quot;, &quot;7-3&quot;))
pp</code></pre>
<pre><code>##   Group p.value    bonf    holm TukeyHSD
## 1   2-1 0.14711 1.00000 0.14711  0.19567
## 2   7-3 0.00003 0.00088 0.00009       NA
## 3   5-4 0.00644 0.18020 0.01287       NA</code></pre>
<pre class="r"><code>library(agricolae)
HSD.test(model, &quot;Cluster&quot;, console = T)</code></pre>
<pre><code>## 
## Study: model ~ &quot;Cluster&quot;
## 
## HSD Test for DTF 
## 
## Mean Square Error:  6.551202 
## 
## Cluster,  means
## 
##        DTF      std   r Min Max
## 1 43.90625 3.170893  64  37  49
## 2 44.40132 2.256000 152  40  49
## 
## Alpha: 0.05 ; DF Error: 214 
## Critical Value of Studentized Range: 2.787572 
## 
## Groups according to probability of means differences and alpha level( 0.05 )
## 
## Treatments with the same letter are not significantly different.
## 
##        DTF groups
## 2 44.40132      a
## 1 43.90625      a</code></pre>
<p>Now lets do another with Rep. Unless there is variability within our field, this should be non-significant.</p>
<p><span class="math display">\[DTF = \mu + Cluster_i + error_i\]</span></p>
<pre class="r"><code>model &lt;- lm(DTF ~ Rep, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: DTF
##            Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
## Rep         2   876.5  438.23  19.421 5.429e-09 ***
## Residuals 942 21255.8   22.56                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>pairwise.t.test(xx$DTF, xx$Rep, p.adj = &quot;bonf&quot;)</code></pre>
<pre><code>## 
##  Pairwise comparisons using t tests with pooled SD 
## 
## data:  xx$DTF and xx$Rep 
## 
##   1       2      
## 2 0.00014 -      
## 3 3.6e-09 0.11004
## 
## P value adjustment method: bonferroni</code></pre>
<p>Rep 1 is significantly different from Rep 2 &amp; 3.</p>
<pre class="r"><code># Plot
means &lt;- xx %&gt;% group_by(Rep) %&gt;% summarise(DTF = mean(DTF))
ggplot(xx, aes(x = Rep, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = &quot;red&quot;, size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  labs(title = &quot;Sutherland, Canada 2017&quot;)</code></pre>
<p><img src="/academic_posts/anova/index_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Looking at the data, Rep 1 does seem slightly different from Rep 2 and 3.</p>
<p>Now let try another year - 2018:</p>
<pre class="r"><code># Prep data
xx &lt;- rr %&gt;% filter(Location == &quot;Sutherland, Canada&quot;, Year == 2018)
# Run ANOVA
model &lt;- lm(DTF ~ Rep, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: DTF
##            Df Sum Sq Mean Sq F value Pr(&gt;F)
## Rep         2    4.2  2.1139  0.2296 0.7949
## Residuals 964 8874.9  9.2064</code></pre>
<p>For this location, the Reps are not significantly different, and in fact look equal when we plot the data.</p>
<pre class="r"><code># Plot
means &lt;- xx %&gt;% group_by(Rep) %&gt;% summarise(DTF = mean(DTF))
ggplot(xx, aes(x = Rep, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = &quot;red&quot;, size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  labs(title = &quot;Sutherland, Canada 2018&quot;)</code></pre>
<p><img src="/academic_posts/anova/index_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
<div style="page-break-after: always;"></div>
</div>
<div id="two-way-anova" class="section level1">
<h1>Two-way ANOVA</h1>
<p><strong>Two-way ANOVA</strong>: used when</p>
<pre class="r"><code>model &lt;- lm(DTF ~ Cluster + Rep, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: DTF
##            Df Sum Sq Mean Sq F value Pr(&gt;F)    
## Cluster     7 6414.4  916.35 356.506 &lt;2e-16 ***
## Rep         2    4.9    2.45   0.954 0.3856    
## Residuals 957 2459.8    2.57                   
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Now lets add an interaction term</p>
<pre class="r"><code>model &lt;- lm(DTF ~ Cluster + Rep + Cluster:Rep, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: DTF
##              Df Sum Sq Mean Sq  F value Pr(&gt;F)    
## Cluster       7 6414.4  916.35 353.5501 &lt;2e-16 ***
## Rep           2    4.9    2.45   0.9461 0.3886    
## Cluster:Rep  14   15.7    1.12   0.4333 0.9643    
## Residuals   943 2444.1    2.59                    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>is the same as</p>
<pre class="r"><code>model &lt;- lm(DTF ~ Cluster * Rep, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: DTF
##              Df Sum Sq Mean Sq  F value Pr(&gt;F)    
## Cluster       7 6414.4  916.35 353.5501 &lt;2e-16 ***
## Rep           2    4.9    2.45   0.9461 0.3886    
## Cluster:Rep  14   15.7    1.12   0.4333 0.9643    
## Residuals   943 2444.1    2.59                    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code># Prep data
locs &lt;- c(&quot;Sutherland, Canada&quot;, &quot;Rosthern, Canada&quot;)
xx &lt;- rr %&gt;% filter(Location %in% locs, Cluster == 4:5)
# Run ANOVA
model &lt;- lm(VEG ~ Year * Cluster, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: VEG
##               Df Sum Sq Mean Sq  F value Pr(&gt;F)    
## Year           2 1319.0  659.52 139.8379 &lt;2e-16 ***
## Cluster        1    2.1    2.09   0.4436 0.5056    
## Year:Cluster   2   12.0    6.01   1.2736 0.2805    
## Residuals    687 3240.1    4.72                    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code># Prep data
locs &lt;- c(&quot;Sutherland, Canada&quot;, &quot;Rosthern, Canada&quot;)
xx &lt;- rr %&gt;% filter(Location %in% locs, Cluster == 7:8)
# Run ANOVA
model &lt;- lm(VEG ~ Year * Cluster, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: VEG
##               Df Sum Sq Mean Sq  F value Pr(&gt;F)    
## Year           2 2214.3 1107.15 177.9276 &lt;2e-16 ***
## Cluster        1 1964.0 1963.96 315.6238 &lt;2e-16 ***
## Year:Cluster   2   13.8    6.89   1.1067 0.3313    
## Residuals    628 3907.7    6.22                    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code># Prep data
locs &lt;- c(&quot;Sutherland, Canada&quot;, &quot;Rosthern, Canada&quot;)
xx &lt;- rr %&gt;% filter(Location %in% locs, Cluster == 7:8)
# Run ANOVA
model &lt;- lm(VEG ~ Year * Cluster, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: VEG
##               Df Sum Sq Mean Sq  F value Pr(&gt;F)    
## Year           2 2214.3 1107.15 177.9276 &lt;2e-16 ***
## Cluster        1 1964.0 1963.96 315.6238 &lt;2e-16 ***
## Year:Cluster   2   13.8    6.89   1.1067 0.3313    
## Residuals    628 3907.7    6.22                    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>model &lt;- lmer(VEG ~ Year * Cluster + (1|Year/Rep), data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
##              npar  Sum Sq Mean Sq  F value
## Year            2   28.66   14.33   2.3275
## Cluster         1 1963.76 1963.76 318.9208
## Year:Cluster    2   12.87    6.44   1.0454</code></pre>
<pre class="r"><code># Prep data
xx &lt;- rr %&gt;% filter(Location == &quot;Sutherland, Canada&quot;)
means &lt;- xx %&gt;% group_by(Year) %&gt;% summarise(DTF = mean(DTF))
# Plot
ggplot(xx, aes(x = Year, y = DTF)) + 
  geom_quasirandom(aes(color = Cluster), alpha = 0.5) +
  geom_point(data = means, fill = &quot;red&quot;, size = 4, pch = 21) +
  scale_color_manual(values = colors) +
  labs(title = &quot;Sutherland, Canada&quot;)</code></pre>
<p><img src="/academic_posts/anova/index_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>#
model &lt;- lm(DTF ~ Year, data = xx) 
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: DTF
##             Df Sum Sq Mean Sq F value    Pr(&gt;F)    
## Year         2  12976  6487.8  418.25 &lt; 2.2e-16 ***
## Residuals 2878  44643    15.5                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>pairwise.t.test(xx$DTF, xx$Year, p.adj = &quot;bonf&quot;)</code></pre>
<pre><code>## 
##  Pairwise comparisons using t tests with pooled SD 
## 
## data:  xx$DTF and xx$Year 
## 
##      2016   2017  
## 2017 1      -     
## 2018 &lt;2e-16 &lt;2e-16
## 
## P value adjustment method: bonferroni</code></pre>
<pre class="r"><code>#
xx &lt;- rr %&gt;% filter(Location == &quot;Sutherland, Canada&quot;)
model &lt;- lmer(DTF ~ Name + Year + (1 | Rep), data = xx)
anova(model)</code></pre>
<pre><code>## Analysis of Variance Table
##      npar Sum Sq Mean Sq  F value
## Name  323  37945   117.5   47.103
## Year    2  13023  6511.7 2610.962</code></pre>
<p>… To Be Continued …</p>
<p><strong>Interpretation</strong>: p value &gt; 0.05 = There is no significant difference for DTF among the genotypes within cluster group 2.</p>
</div>
<div id="nepal" class="section level1">
<h1>Nepal</h1>
<p>y ~ x1*x2 + (1|x2/r1/b1)</p>
<p>Now, lets run the One-way ANOVA:</p>
</div>
