---
title: "Augmented Designs"
subtitle: "Exploration of the data analysis of augmented designs"
summary:  "Exploration of the data analysis of augmented designs"
author: "Derek Michael Wright <derek.wright@usask.ca> [www.dblogr.com/](https://dblogr.netlify.com/)"
date: "2020-03-01"
categories: [ "Academic" ]
tags: [ "Academic", "EVOLVES", "Featured" ]
math: yes
image:
  preview_only: yes
links:
  - icon_pack: fas
    icon: chart-line
    name: All Graphs
    url: academic_graphs/augmented_designs
  - icon: file-code
    icon_pack: far
    name: HTML
    url: https://derekmichaelwright.github.io/htmls/academic/augmented_designs.html
  - icon: file-pdf
    icon_pack: far
    name: PDF (Save/Print)
    url: academic_pdfs/augmented_designs.pdf
---



<hr />
<pre class="r"><code># devtools::install_github(&quot;derekmichaelwright/dblogr&quot;)
library(dblogr) # Loads: tidyverse, ggpubr, ggbeeswarm, ggrepel
library(readxl) # read_xlsx()
library(latex2exp)  # TeX()</code></pre>
<div id="introduction-to-augmented-designs" class="section level1">
<h1>Introduction to Augmented Designs</h1>
<p>Augmented designs were developed (Federer, 1956) as a way of controlling error in plant breeding trials which often have many genotypes that need to be tested, and limited seed or resources to do proper replications of all material. Therfore, in order to control for the heterogenity that exists within a field, a set of check cultivars are replicated in each <em>block</em>. The block effects and error estimated from the replicated checks, is then used to adjust the values of each new genotype being tested.</p>
<p><strong>Federer, W.</strong> (1956) Augmented (or hoonuiaku) designs. <em>Hawaiian Planters Record</em>.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="augmented-rcbd" class="section level1">
<h1>Augmented RCBD</h1>
<p>In a <strong>Randomized Complete Block Design</strong> (<strong>RCBD</strong>), every genotype is present in each block, making each block a replicate with entries randomized within. As such, a field trial of 4 genotpes (A, B, C, D), with 4 replicates each (4 blocks) will look something like this:</p>
<p><img src="Aug_00_1.png" /></p>
<p>In an <strong>Augmented RCBD</strong>, the idea is to have a small set of check varieties which are present in each block, <em>i.e.</em>, an RCBD, augmented with unreplicated test varieties. <em>E.g.,</em> lets say we have 8 test varieties named: e, f, g, h, i, j, k, l. Our field trial might look like this:</p>
<p><img src="Aug_00_2.png" /></p>
<div style="page-break-after: always;"></div>
<p>Now lets explore the data analysis for such a trial. This data comes from a trial on Field 78 at Pioneer Mill Sugar Company, 1931 (<strong>Federer, 1956</strong>), which had 3 different level ditches (blocks), and the recorded data was in tons of sugar cane per acre (TCA).</p>
<pre class="r"><code># Prep data
xx &lt;- read_xlsx(&quot;ExampleData.xlsx&quot;, &quot;RCBD&quot;) %&gt;%
  mutate(Fill = ifelse(Genotype %in% c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;), Genotype, &quot;X&quot;),
         Type = ifelse(Genotype %in% c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;), &quot;Check&quot;, &quot;Treatment&quot;))
mycolors &lt;- c(&quot;darkgreen&quot;,&quot;darkred&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;,&quot;white&quot;)
# Plot data
mp &lt;- ggplot(xx, aes(x = &quot;&quot;, y = Row)) + 
  geom_tile(aes(fill = Fill), color = &quot;black&quot;, alpha = 0.75) + 
  geom_text(aes(label = paste(Genotype, Yield, sep = &quot; = &quot;))) +
  facet_grid(.~Block) +
  scale_fill_manual(values = mycolors) +
  scale_y_reverse() +
  theme_dblogr(legend.position = &quot;none&quot;,
               axis.text.y = element_blank()) +
  labs(title = &quot;Tons of sugar cane per acre&quot;, y = NULL, x = NULL)
ggsave(&quot;Aug_01_01.png&quot;, mp, width = 6, height = 3)</code></pre>
<p><img src="Aug_01_01.png" /></p>
<pre class="r"><code>xt &lt;- xx %&gt;% filter(Type != &quot;Check&quot;)
xc &lt;- xx %&gt;% filter(Type == &quot;Check&quot;)
mp &lt;- ggplot(xx, aes(x = Block, y = Yield, color = Fill, shape = Type)) + 
  geom_beeswarm(size = 3) +
  geom_text_repel(data = xt, aes(label = Genotype), nudge_x = 0.1) +
  scale_color_manual(values = c(mycolors[1:4], &quot;grey30&quot;)) +
  guides(shape = F) + ylim(c(70,96)) +
  theme_dblogr(legend.position = &quot;none&quot;) +
  labs(y = &quot;Tons of sugar cane per acre&quot;, x = NULL)
ggsave(&quot;Aug_01_02.png&quot;, mp, width = 6, height = 3)</code></pre>
<p><img src="Aug_01_02.png" /></p>
<p>But first lets focus on the unreplicated test varieties.</p>
<pre class="r"><code>mp &lt;- ggplot(xx, aes(x = Block, y = Yield, color = Fill, shape = Type, alpha = Type)) + 
  geom_beeswarm(size = 3) +
  geom_text_repel(data = xt, aes(label = Genotype), nudge_x = 0.1) +
  scale_color_manual(values = c(mycolors[1:4], &quot;grey30&quot;)) +
  scale_alpha_manual(values = c(0.2,1)) +
  guides(shape = F) + ylim(c(70,96)) +
  theme_dblogr(legend.position = &quot;none&quot;) +
  labs(y = &quot;Tons of sugar cane per acre&quot;, x = NULL)
ggsave(&quot;Aug_01_03.png&quot;, mp, width = 6, height = 3)</code></pre>
<p><img src="Aug_01_03.png" /></p>
<p>Clearly there are strong block effects, which is problematic since our test varieties are unreplicated, making comparions among genotypes from different blocks potentially unreliable. <em>E.g.,</em> is genotype <strong>j</strong> a higher yielding genotype than <strong>k</strong>? Or, is it just in a block where all genotypes yield higher? By runnaing an ANOVA on the replicated check varieties, we can get an estimate of the block effects and adjust our data accordingly.</p>
<pre class="r"><code>eq &lt;- TeX(&quot;$y_{ij}=\\mu+b_i+g_i+error_{ij}$&quot;)
mp &lt;- ggplot(xx, aes(x = Block, y = Yield, color = Fill, shape = Type, alpha = Type)) + 
  geom_beeswarm(size = 3) +
  geom_text(x = 1, y = 95, label = eq, parse = T, size = 6) + 
  scale_color_manual(values = c(mycolors[1:4], &quot;grey30&quot;)) +
  scale_alpha_manual(values = c(1,0.2)) +
  guides(shape = F) + ylim(c(70,96)) +
  theme_dblogr(legend.position = &quot;none&quot;) +
  labs(y = &quot;Tons of sugar cane per acre&quot;, x = NULL)
ggsave(&quot;Aug_01_04.png&quot;, mp, width = 6, height = 3)</code></pre>
<p><img src="Aug_01_04.png" /></p>
<p><span class="math display">\[y_{ij}=\mu+b_i+g_j+error_{ij}\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(\mu\)</span> = Mean</li>
<li><span class="math inline">\(b_i\)</span> = Block effect</li>
<li><span class="math inline">\(g_j\)</span> = Genotype effect</li>
<li><span class="math inline">\(error_ij\)</span> = random error</li>
</ul>
<pre class="r"><code>fit &lt;- lm(Yield ~ Block + Genotype, data = xc)
aov(fit)</code></pre>
<pre><code>## Call:
##    aov(formula = fit)
## 
## Terms:
##                     Block  Genotype Residuals
## Sum of Squares   69.50000  52.91667 161.83333
## Deg. of Freedom         2         3         6
## 
## Residual standard error: 5.193479
## Estimated effects may be unbalanced</code></pre>
<pre class="r"><code>coef(fit)</code></pre>
<pre><code>## (Intercept) BlockBlock2 BlockBlock3   GenotypeB   GenotypeC   GenotypeD 
##   81.416667    4.000000    5.750000   -5.666667   -2.666667   -1.333333</code></pre>
<pre class="r"><code>blockeffects &lt;- c(coef(fit)[2:3], sum(-as.numeric(coef(fit)[2:3])))
names(blockeffects)[3] &lt;- &quot;Block3&quot;
blockeffects</code></pre>
<pre><code>## BlockBlock2 BlockBlock3      Block3 
##        4.00        5.75       -9.75</code></pre>
<pre class="r"><code>xx &lt;- xx %&gt;% 
  mutate(BlockEffect = as.numeric(plyr::mapvalues(Block, 
            c(&quot;Block1&quot;,&quot;Block2&quot;,&quot;Block3&quot;), blockeffects)),
         Adj_Yield = Yield - BlockEffect)
xt &lt;- xx %&gt;% filter(Type != &quot;Check&quot;) %&gt;% arrange(Yield) %&gt;%
  mutate(Genotype = factor(Genotype, levels = Genotype))
mp &lt;- ggplot(xt, aes(x = Genotype, color = Block)) + 
  geom_point(aes(y = Yield), size = 3, alpha = 0.2) +
  geom_point(aes(y = Adj_Yield), size = 3) + 
  geom_errorbar(aes(ymin = Yield, ymax = Adj_Yield), size = 1, width = 0) +
  #facet_grid(.~Type, scales = &quot;free_x&quot;, space = &quot;free_x&quot;) +
  scale_color_manual(values = dblogr_Colors[c(10,11,7)]) +
  theme_dblogr(legend.position = &quot;bottom&quot;) +
  labs(title = &quot;Block Effect Adjustments&quot;, y = &quot;Tons of sugar cane per acre&quot;)
ggsave(&quot;Aug_01_05.png&quot;, mp, width = 6, height = 4)</code></pre>
<p><img src="Aug_01_05.png" /></p>
<p>We can also do this with the <code>R</code> package <a href="https://aravind-j.github.io/augmentedRCBD/index.html">agumentedRCBD</a> which contains a function <code>augmentedRCBD</code> that can carry make these adjustments.</p>
<pre class="r"><code>library(augmentedRCBD) # devtools::install_github(&quot;aravind-j/augmentedRCBD&quot;)
xx &lt;- xx %&gt;% mutate(Block = factor(Block), Genotype = factor(Genotype))
out &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Genotype, y = xx$Yield, 
                     checks = c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;), group = F)</code></pre>
<pre><code>## 
## Augmented Design Details
## ========================
##                                        
## Number of blocks           &quot;3&quot;         
## Number of treatments       &quot;12&quot;        
## Number of check treatments &quot;4&quot;         
## Number of test treatments  &quot;8&quot;         
## Check treatments           &quot;A, B, C, D&quot;
## 
## ANOVA, Treatment Adjusted
## =========================
##                                      Df Sum Sq Mean Sq F value Pr(&gt;F)  
## Block (ignoring Treatments)           2  360.1  180.04   6.675 0.0298 *
## Treatment (eliminating Blocks)       11  285.1   25.92   0.961 0.5499  
##   Treatment: Check                    3   52.9   17.64   0.654 0.6092  
##   Treatment: Test and Test vs. Check  8  232.2   29.02   1.076 0.4779  
## Residuals                             6  161.8   26.97                 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## ANOVA, Block Adjusted
## =====================
##                                Df Sum Sq Mean Sq F value Pr(&gt;F)
## Treatment (ignoring Blocks)    11  575.7   52.33   1.940  0.215
##   Treatment: Check              3   52.9   17.64   0.654  0.609
##   Treatment: Test               7  505.9   72.27   2.679  0.125
##   Treatment: Test vs. Check     1   16.9   16.88   0.626  0.459
## Block (eliminating Treatments)  2   69.5   34.75   1.288  0.342
## Residuals                       6  161.8   26.97               
## 
## Treatment Means
## ===============
##    Treatment  Block    Means       SE r Min Max Adjusted Means
## 1          A        84.66667 3.844188 3  79  92       84.66667
## 2          B        79.00000 1.154701 3  77  81       79.00000
## 3          C        82.00000 2.645751 3  78  87       82.00000
## 4          D        83.33333 3.929942 3  78  91       83.33333
## 5          e Block2 79.00000       NA 1  79  79       78.25000
## 6          f Block3 89.00000       NA 1  89  89       86.50000
## 7          g Block1 70.00000       NA 1  70  70       73.25000
## 8          h Block3 96.00000       NA 1  96  96       93.50000
## 9          i Block2 78.00000       NA 1  78  78       77.25000
## 10         j Block3 82.00000       NA 1  82  82       79.50000
## 11         k Block1 75.00000       NA 1  75  75       78.25000
## 12         l Block1 74.00000       NA 1  74  74       77.25000
## 
## Coefficient of Variation
## ========================
## 6.372367
## 
## Overall Adjusted Mean
## =====================
## 81.0625
## 
## Standard Errors
## ===================
##                                          Std. Error of Diff.  CD (5%)
## Control Treatment Means                             4.240458 10.37603
## Two Test Treatments (Same Block)                    7.344688 17.97180
## Two Test Treatments (Different Blocks)              8.211611 20.09309
## A Test Treatment and a Control Treatment            6.704752 16.40594</code></pre>
<pre class="r"><code>out[[2]] # Adjusted Means</code></pre>
<pre><code>##    Treatment  Block    Means       SE r Min Max Adjusted Means
## 1          A        84.66667 3.844188 3  79  92       84.66667
## 2          B        79.00000 1.154701 3  77  81       79.00000
## 3          C        82.00000 2.645751 3  78  87       82.00000
## 4          D        83.33333 3.929942 3  78  91       83.33333
## 5          e Block2 79.00000       NA 1  79  79       78.25000
## 6          f Block3 89.00000       NA 1  89  89       86.50000
## 7          g Block1 70.00000       NA 1  70  70       73.25000
## 8          h Block3 96.00000       NA 1  96  96       93.50000
## 9          i Block2 78.00000       NA 1  78  78       77.25000
## 10         j Block3 82.00000       NA 1  82  82       79.50000
## 11         k Block1 75.00000       NA 1  75  75       78.25000
## 12         l Block1 74.00000       NA 1  74  74       77.25000</code></pre>
<pre class="r"><code>out[[5]] # Block Effects</code></pre>
<pre><code>## Block1 Block2 Block3 
##  -3.25   0.75   2.50</code></pre>
<pre class="r"><code>out[[6]] # Genotype Effects</code></pre>
<pre><code>##         A         B         C         D         e         f         g         h 
##  3.604167 -2.062500  0.937500  2.270833 -2.812500  5.437500 -7.812500 12.437500 
##         i         j         k         l 
## -3.812500 -1.562500 -2.812500 -3.812500</code></pre>
<pre class="r"><code>out[[7]] # Standard Errors </code></pre>
<pre><code>##                                          Std. Error of Diff.  CD (5%)
## Control Treatment Means                             4.240458 10.37603
## Two Test Treatments (Same Block)                    7.344688 17.97180
## Two Test Treatments (Different Blocks)              8.211611 20.09309
## A Test Treatment and a Control Treatment            6.704752 16.40594</code></pre>
<pre class="r"><code>out[[8]] # Overal Mean</code></pre>
<pre><code>## [1] 81.0625</code></pre>
<pre class="r"><code>out[[9]] # CV</code></pre>
<pre><code>## [1] 6.372367</code></pre>
<p><img src="Aug_01_06.png" /></p>
<p><img src="Aug_01_07.png" /></p>
<p><img src="Aug_01_08.png" /></p>
<p><img src="Aug_01_09.png" /></p>
<p><img src="Aug_01_10.png" /></p>
<p>To help better understand, lets do these calculations ourselves.</p>
<p>Calculate block effects:</p>
<p><span class="math display">\[b_i=\frac{1}{n_c}*\left(\sum{y}_{bi}-\sum{\bar{y}}_c-\sum{y}_{ti}\right)\]</span></p>
<ul>
<li><span class="math inline">\(b_i\)</span> = block effect</li>
<li><span class="math inline">\(n_c\)</span> = number of check varieties</li>
<li><span class="math inline">\(\sum{y}_{bi}\)</span> = sum of all measurements within block</li>
<li><span class="math inline">\(\sum{\bar{y}}_c\)</span> = sum of check means</li>
<li><span class="math inline">\(\sum{y}_{ti}\)</span> = measurement for individual treatment within block</li>
</ul>
<p>Block1 effects:</p>
<p><span class="math display">\[b_1=\frac{1}{4}*\left(535-329-219\right)=-3.25\]</span></p>
<p><span class="math display">\[\sum{y}_{b1}=74+78+78+70+83+77+75=535\]</span></p>
<p><span class="math display">\[\sum{\bar{y}}_c=84.67+79.00+82.00+83.33=329\]</span></p>
<p><span class="math display">\[\sum{y}_{t1}=74+70+75=219\]</span></p>
<pre class="r"><code># Data prep
y_c &lt;- xx %&gt;% filter(Genotype %in% c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;)) %&gt;%
  group_by(Genotype) %&gt;% summarise(Mean = mean(Yield))
y_c</code></pre>
<pre><code>## # A tibble: 4 x 2
##   Genotype  Mean
##   &lt;chr&gt;    &lt;dbl&gt;
## 1 A         84.7
## 2 B         79  
## 3 C         82  
## 4 D         83.3</code></pre>
<pre class="r"><code># Block1 effects
y_t1 &lt;- xx$Yield[xx$Block==&quot;Block1&quot; &amp; xx$Type==&quot;Treatment&quot;]
y_b1 &lt;- xx$Yield[xx$Block==&quot;Block1&quot;]
b1 &lt;- ( 1/4 ) * ( sum(y_b1, -y_c$Mean, -y_t1) ) 
# Block2 effects
y_t2 &lt;- xx$Yield[xx$Block==&quot;Block2&quot; &amp; xx$Type==&quot;Treatment&quot;]
y_b2 &lt;- sum(xx$Yield[xx$Block==&quot;Block2&quot;])
b2 &lt;- ( 1/4 ) * ( sum(y_b2, -y_c$Mean, -y_t2) ) 
# Block3 effects
y_t3 &lt;- xx$Yield[xx$Block==&quot;Block3&quot; &amp; xx$Type==&quot;Treatment&quot;]
y_b3 &lt;- sum(xx$Yield[xx$Block==&quot;Block3&quot;])
b3 &lt;- ( 1/4 ) * ( sum(y_b3, -y_c$Mean, -y_t3) ) 
bb &lt;- data.frame(Block = c(&quot;Block1&quot;,&quot;Block2&quot;,&quot;Block3&quot;),
                 Block_Effect = c(b1, b2, b3))
bb</code></pre>
<pre><code>##    Block Block_Effect
## 1 Block1        -3.25
## 2 Block2         0.75
## 3 Block3         2.50</code></pre>
<p>Calculate mean effect</p>
<p><span class="math display">\[m=\frac{1}{n_c+n_t}*\left(\sum{y}-(n_b-1)*\sum{\bar{y}}_c-\sum{(b_i*n_{ti})}\right)\]</span></p>
<ul>
<li><span class="math inline">\(m\)</span> = mean effect</li>
<li><span class="math inline">\(n_t\)</span> = number of treatments (test varieties)</li>
<li><span class="math inline">\(\sum{y}\)</span> = sum of all measurements</li>
<li><span class="math inline">\(n_ti\)</span> = number of treatments (test varieties) wintin block</li>
<li><span class="math inline">\(n_b\)</span> = number of blocks</li>
</ul>
<p><span class="math display">\[m=\frac{1}{4+8}*\left(1630-(3-1)*329-(-0.75)\right)=81.0625\]</span></p>
<p><span class="math display">\[\sum{y}=74+78+78...81+79+82=1630\]</span></p>
<p><span class="math display">\[\sum{(b_i*n_{ti}})=\left(3*(-3.25)+2*(0.75)+3*(2.5)\right)=-0.75\]</span></p>
<pre class="r"><code>m &lt;- ( 1/(4+8) ) * ( sum(xx$Yield) - (3 - 1) * sum(y_c$Mean) - sum(3 * b1 + 2 * b2 + 3 * b3) )
m</code></pre>
<pre><code>## [1] 81.0625</code></pre>
<p>Calculate genotype effects</p>
<pre class="r"><code>xx &lt;- xx %&gt;% 
  left_join(y_c, by = &quot;Genotype&quot;) %&gt;%
  left_join(bb, by = &quot;Block&quot;) %&gt;%
  mutate(AdjMean = ifelse(Type == &quot;Treatment&quot;, Yield - BlockEffect, Mean),
         GenotypeEffect = AdjMean - m)</code></pre>
<p>The sum of block effects should add to zero, along with the sum of check effects and treatment effects</p>
<pre class="r"><code>sum(bb$BlockEffect)</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code>checkEffects &lt;- unique(xx$GenotypeEffect[xx$Type == &quot;Check&quot;])
treatmentEffects &lt;- xx$GenotypeEffect[xx$Type == &quot;Treatment&quot;]
sum(checkEffects, treatmentEffects)</code></pre>
<pre><code>## [1] -1.278977e-13</code></pre>
<p>Calculate total sum of squares</p>
<p><span class="math display">\[SS_t=\sum{y}^2-\frac{(\sum{y})^2}{n}=133652-\frac{1630^2}{20}=807\]</span></p>
<pre class="r"><code>sum(xx$Yield^2) - (sum(xx$Yield)^2 / 20)</code></pre>
<pre><code>## [1] 807</code></pre>
<p><span class="math inline">\(n_g\)</span> = number of genotypes</p>
<p><span class="math display">\[SS_t=1630^2\]</span></p>
</div>
<div id="modified-type-ii-design" class="section level1">
<h1>Modified Type II design</h1>
<p>Modified augmented design (type II) was developed to account for row and column and heterogeneity.</p>
<p>Table S1 – The raw phenotypic data of a population with 243 RILs derived from a cross between ‘CDC Bethune’ and ‘Macbeth’ (BM) for the case study.</p>
<p><a href="https://data.nal.usda.gov/dataset/data-estimation-genetic-parameters-and-their-sampling-variances-quantitative-traits-type-2-modified-augmented-design">download data set</a></p>
<p><a href="https://www.sciencedirect.com/science/article/pii/S2214514116000179">Paper</a></p>
<pre class="r"><code>checks &lt;- data.frame(Check = c(&quot;Check1&quot;,&quot;Check2&quot;,&quot;Check3&quot;),
                     Name = c(&quot;CDC Bethune&quot;,&quot;Hanley&quot;,&quot;Macbeth&quot;))
dd &lt;- read_xlsx(&quot;ExampleData.xlsx&quot;, &quot;MAD2&quot;) %&gt;% 
  rename(MainCheck=`Cp (plot control)`, SubCheck=`Csp (sub-plot control)`) %&gt;%
  mutate(#Type = ifelse(Genotype %in% checks$Name, Genotype, &quot;Treatment&quot;),
         #Type = plyr::mapvalues(Type, checks$Name, checks$Check),
         Type = ifelse(MainCheck == 1, &quot;Check1&quot;, &quot;Treatment&quot;),
         Type = ifelse(SubCheck == 1, &quot;Check2&quot;, Type),
         Type = ifelse(SubCheck == 2, &quot;Check3&quot;, Type),
         Type = factor(Type, levels = c(&quot;Treatment&quot;,&quot;Check1&quot;,&quot;Check2&quot;,&quot;Check3&quot;)),
         Block = paste0(Row, Col),
         Block = plyr::mapvalues(Block, c(11:17,21:27,31:37,41:47,51:57,61:67,71:77), 1:49),
         Block = factor(Block, levels = 1:49)) %&gt;%
  as.data.frame()
#
expt &lt;- &quot;M2009&quot;
gg_Fieldplan &lt;- function(xx, expt) {
  xi &lt;- xx %&gt;% filter(Environment == expt)
  mp &lt;- ggplot(xi, aes(x = 1, y = SubPlotNum)) + 
    geom_tile(aes(fill = Type), color = &quot;black&quot;, alpha = 0.5) + 
    geom_text(aes(label = Genotype)) +
    facet_grid(Row~Col) +
    scale_fill_manual(values = c(&quot;white&quot;,&quot;darkred&quot;,&quot;darkblue&quot;,&quot;darkgreen&quot;)) +
    scale_y_reverse() + 
    labs(title = paste(expt, &quot;- Field plan&quot;)) +
    theme_dblogr(axis.text = element_blank(), axis.ticks = element_blank(),
                 strip.text.x = element_blank(), legend.position = &quot;none&quot;)
  ggsave(paste0(&quot;Aug_02_01_&quot;, expt, &quot;.png&quot;), mp, width = 20, height = 20)
}
unique(dd$Environment)</code></pre>
<pre><code>## [1] &quot;M2009&quot; &quot;M2010&quot; &quot;M2011&quot; &quot;M2012&quot; &quot;S2009&quot; &quot;S2010&quot; &quot;S2011&quot; &quot;S2012&quot;</code></pre>
<pre class="r"><code>gg_Fieldplan(dd, &quot;M2009&quot;)
gg_Fieldplan(dd, &quot;M2010&quot;)
gg_Fieldplan(dd, &quot;M2011&quot;)
gg_Fieldplan(dd, &quot;M2012&quot;)
gg_Fieldplan(dd, &quot;S2009&quot;)
gg_Fieldplan(dd, &quot;S2010&quot;)
gg_Fieldplan(dd, &quot;S2011&quot;)
gg_Fieldplan(dd, &quot;S2012&quot;)
x4 &lt;- dd %&gt;% filter(Genotype == &quot;CDC Bethune&quot;)
x5 &lt;- dd %&gt;% filter(Genotype %in% c(&quot;Hanley&quot;,&quot;Macbeth&quot;))</code></pre>
<pre class="r"><code>#
x1 &lt;- dd %&gt;% filter(Environment == &quot;M2009&quot;)
length(4001:4343)
7*7*7
mp &lt;- ggplot(x1, aes(x = 1, y = SubPlotNum)) + 
  geom_tile(fill = NA, color = &quot;black&quot;) + 
  geom_text(aes(label = Plot)) +
  facet_wrap(Row~Col, scales = &quot;free&quot;) +
  scale_y_reverse() +
  theme_dblogr(axis.text = element_blank(), axis.ticks = element_blank(),
               strip.text.x = element_blank(), legend.position = &quot;none&quot;)
ggsave(&quot;test1.png&quot;, mp, width = 20, height = 20)
mp &lt;- ggplot(x1, aes(x = 1, y = SubPlotNum)) + 
  geom_tile(aes(fill = Type), color = &quot;black&quot;) + 
  geom_text(aes(label = Genotype)) +
  facet_wrap(Row~Col, scales = &quot;free&quot;) +
  scale_y_reverse() +
  theme_dblogr(axis.text = element_blank(), axis.ticks = element_blank(),
               strip.text.x = element_blank(), legend.position = &quot;none&quot;)
ggsave(&quot;test2.png&quot;, mp, width = 20, height = 20)
mp &lt;- ggplot(x1, aes(x = 1, y = Plot)) + 
  geom_tile(aes(fill = Yield), color = &quot;black&quot;) + 
  geom_text(aes(label = Yield)) +
  facet_wrap(Row~Col, scales = &quot;free&quot;) +
  scale_y_reverse() +
  scale_fill_continuous(low = &quot;white&quot;, high = &quot;darkred&quot;) +
  theme_dblogr(axis.text = element_blank(), axis.ticks = element_blank(),
               strip.text.x = element_blank(), legend.position = &quot;none&quot;)
ggsave(&quot;test3.png&quot;, mp, width = 20, height = 20)
x2 &lt;- x1 %&gt;% filter(Type == &quot;Check1&quot;) %&gt;% arrange(Yield) 
x2 &lt;- x1 %&gt;% mutate(Block = factor(Block, levels = unique(x2$Block)))
#x2 &lt;- xx %&gt;% filter(Environment == &quot;M2009&quot;, Type == &quot;Check&quot;) %&gt;% 
#  mutate(Block = factor(Block, levels = x2$Block))
mp &lt;- ggplot(x2, aes(x = Block, y = Yield, color = Type, pch = Type)) + 
  geom_beeswarm() +
  scale_color_manual(values = c(&quot;darkgreen&quot;, &quot;darkred&quot;,&quot;darkblue&quot;, &quot;Black&quot;))
ggsave(&quot;test4.png&quot;, mp, width = 15, height = 6)
x3 &lt;- x2 %&gt;% filter(Type != &quot;Treatment&quot;)
mp &lt;- ggplot(x2, aes(x = Block, y = Yield, color = Type, pch = Type)) + 
  geom_beeswarm() +
  geom_line(data = x3, aes(group = Type)) +
  scale_color_manual(values = c(&quot;darkgreen&quot;, &quot;darkred&quot;,&quot;darkblue&quot;, &quot;Black&quot;))
ggsave(&quot;test5.png&quot;, mp, width = 15, height = 6)</code></pre>
<p>Method I (adjustment by design structure)</p>
<p><span class="math display">\[Y`_{ij(k)}=Y_{ij(k)}-R_i-C_j\]</span></p>
<p><span class="math display">\[R_i=\sum^{c}_{ij}X_{ij(A)}/c-\bar(X)_A\]</span></p>
<p><span class="math display">\[C_j=\sum^{r}_{ij}X_{ij(A)}/r-\bar(X)_A\]</span></p>
<p><span class="math display">\[\bar(X)_A=\sum_i}\sum_jX_{ij(A)}/rc\]</span></p>
<p>Method II</p>
<p>Method II (adjustment by regression)</p>
<p><span class="math inline">\(Y`\)</span></p>
<p>Other…</p>
<p>Method I</p>
<p><span class="math display">\[m_a=y_{rc}-(\bar{c}_r-\bar{c})-(\bar{c}_c-\bar{c})\]</span></p>
<ul>
<li><span class="math inline">\(m_a\)</span> = Adjusted mean</li>
<li><span class="math inline">\(y_{rc}\)</span> = Raw data of plot in row <span class="math inline">\(_r\)</span> and column <span class="math inline">\(_c\)</span></li>
<li><span class="math inline">\(\bar{c}\)</span> = Mean of all check1</li>
<li><span class="math inline">\(\bar{c}_r\)</span> = Mean of check1 in row <span class="math inline">\(_r\)</span></li>
<li><span class="math inline">\(\bar{c}_c\)</span> = Mean of check1 in column <span class="math inline">\(_c\)</span></li>
</ul>
<p>Method III</p>
<p><span class="math display">\[m_a=y_{rc}-slope*(\bar{c}_r-\bar{c})-(\bar{c}_c-\bar{c})=y_{rc}-\bar{c}_r-\bar{c}_c-2\bar{c}\]</span></p>
<pre class="r"><code>x1 &lt;- dd %&gt;% filter(Environment == &quot;M2009&quot;)
#
xx &lt;- x1
trait &lt;- &quot;Yield&quot;
MAD2_M1 &lt;- function(xx, trait) {
  yy &lt;- rep(NA,nrow(xx))
  xc &lt;- xx %&gt;% filter(Type == &quot;Check1&quot;)
  for(i in 1:nrow(xx)) {
    yrc &lt;- xx[i,trait]
    c_m &lt;- mean(xc %&gt;% pull(trait), na.rm = T)
    c_r &lt;- mean(xc %&gt;% filter(Row == xx%&gt;%slice(i)%&gt;%pull(&quot;Row&quot;)) %&gt;% pull(trait), na.rm = T)
    c_c &lt;- mean(xc %&gt;% filter(Col == xx%&gt;%slice(i)%&gt;%pull(&quot;Col&quot;)) %&gt;% pull(trait), na.rm = T)
    yy[i] &lt;- yrc - (c_r - c_m) - (c_c - c_m)
  }
  yy
}
xx &lt;- xx %&gt;% mutate(Yield_adj_M1 = MAD2_M1(., &quot;Yield&quot;))
ggplot(xx, aes(x = Yield, y = Yield_adj_M1)) + geom_point()</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<pre class="r"><code>#library(lme4)
xx &lt;- read_xlsx(&quot;ExampleData.xlsx&quot;, &quot;Type2&quot;)
fit &lt;- lm(Check23Avg ~ Check1, data = xx)
#fit &lt;- lm(Check1 ~ Check23Avg, data = xx)
fit</code></pre>
<pre><code>## 
## Call:
## lm(formula = Check23Avg ~ Check1, data = xx)
## 
## Coefficients:
## (Intercept)       Check1  
##      2.9503       0.6961</code></pre>
<pre class="r"><code>mean(xx$Check1)</code></pre>
<pre><code>## [1] 5.3075</code></pre>
<pre class="r"><code>xx &lt;- read_xlsx(&quot;ExampleData.xlsx&quot;, &quot;LongRows&quot;)
xr &lt;- xx %&gt;% group_by(Name, Row) %&gt;% summarise(Mean = mean(Unadj))
xc &lt;- xx %&gt;% group_by(Name, Col) %&gt;% summarise(Mean = mean(Unadj))
xb &lt;- xx %&gt;% group_by(Block) %&gt;% summarise(Mean = mean(Unadj))
xg &lt;- xx %&gt;% group_by(Name) %&gt;% summarise(Mean = mean(Unadj))
# Row 3 Colum 1
23.8 - 23.8 - 23.8 + (2*25.45)</code></pre>
<pre><code>## [1] 27.1</code></pre>
<pre class="r"><code>23.8 - (23.8-25.45) - (23.8-25.45)</code></pre>
<pre><code>## [1] 27.1</code></pre>
<pre class="r"><code>x1 &lt;- xx %&gt;% select(Block, Row, Col, Name, Unadj) %&gt;% spread(Name, Unadj) %&gt;%
  mutate(BC = (B + C) / 2)
fit &lt;- lm(BC ~ A, data = x1)
fit</code></pre>
<pre><code>## 
## Call:
## lm(formula = BC ~ A, data = x1)
## 
## Coefficients:
## (Intercept)            A  
##      -5.449        1.171</code></pre>
<pre class="r"><code>23.8 - 1.171*(23.8-25.45)</code></pre>
<pre><code>## [1] 25.73215</code></pre>
</div>
<div id="load-dataset-1" class="section level1">
<h1>Load Dataset 1</h1>
<ul>
<li><code>Entry</code>: 1 Lentil Genotype</li>
<li><code>Expt</code>: 18 Site-years</li>
<li><code>DTF</code>: Days from sowing to flower</li>
<li><code>DTM</code>: Days from sowing to swollen pod</li>
<li><code>DTM</code>: Days from sowing to maturity</li>
<li><code>RDTF</code>: Rate of progress towards fowering</li>
</ul>
<pre class="r"><code># Prep data
d19 &lt;- read_xlsx(&quot;NAM_2019_Sutherland.xlsx&quot;, &quot;Measurements&quot;)
d20 &lt;- read_xlsx(&quot;NAM_2020_Sutherland.xlsx&quot;, &quot;Measurements&quot;)
#
checks &lt;- d19 %&gt;% filter(Generation == &quot;Check&quot;, Block == 1) %&gt;%
  select(Name, Check = Population) %&gt;% arrange(Check)
#
d19 &lt;- d19 %&gt;% 
  filter(!is.na(Block)) %&gt;%
  mutate(Name = plyr::mapvalues(Name, checks$Name, checks$Check),
         Selected = ifelse(Name %in% d20$Name, &quot;Yes&quot;, &quot;No&quot;),
         VEG = DTF - DTE,
         REP = DTM - DTF)
sum(is.na(d19$Name))</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code>sum(is.na(d19$Block))</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code>sum(is.na(d19$DTF))</code></pre>
<pre><code>## [1] 21</code></pre>
<pre class="r"><code># Preview data
# knitr::kable(dd[1:10])
# dd$Comments[is.na(dd$DTT)]</code></pre>
<pre class="r"><code>#checks &lt;- as.character(unique(xx$Name[xx$Generation==&quot;Check&quot;]))
#
#summary(xx$Name)
#sum(is.na(xx$Name))
#sum(is.na(xx$Block))
#sum(is.na(xx$DTF))</code></pre>
</div>
<div id="analysis" class="section level1">
<h1>Analysis</h1>
<p>… To Be Continued …</p>
<pre class="r"><code>trait &lt;- &quot;DTF&quot;
checks &lt;- paste0(&quot;Check&quot;, 1:6)
xx &lt;- d19 %&gt;% rename(Trait=trait) %&gt;% filter(!is.na(Trait)) %&gt;% # Block %in% 1:3, ,  | Name %in% lines
  mutate(Block = factor(Block), Name = factor(Name))
#
out &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$Trait, checks = checks, 
                     console = F, group = F)
zz &lt;- xx %&gt;% left_join(select(out[[2]], Name=Treatment, Means, `Adjusted Means`), by = &quot;Name&quot;)
#
c_mean &lt;- mean(zz$Trait[zz$Generation == &quot;Check&quot;])
zc &lt;- zz %&gt;% filter(Name %in% checks)
zcm &lt;- zc %&gt;% group_by(Name) %&gt;% summarise(Trait = mean(Trait)) %&gt;% mutate(Diff = Trait - c_mean)
zbm &lt;- zc %&gt;% group_by(Block) %&gt;% summarise(Trait = mean(Trait)) %&gt;% mutate(Diff = Trait - c_mean)
#
zz &lt;- zz %&gt;%
  mutate(Type = ifelse(Name %in% checks, as.character(Name), &quot;Line&quot;),
         Diff = Trait - `Adjusted Means`,
         cMean = ifelse(Generation == &quot;Check&quot;, as.character(Name), NA),
         cMean = plyr::mapvalues(cMean, as.character(zcm$Name), as.character(zcm$Trait)),
         cMean = as.numeric(as.character(cMean)),
         AdjMean = ifelse(Generation == &quot;Check&quot;, cMean, Trait - Diff))
#
tot_avg &lt;- mean(xx$Trait)
# Checks
ggplot(zc, aes(x = Name, y = Trait, color = Name)) + 
  geom_beeswarm() + geom_point(data = zcm, color = &quot;black&quot;) </code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<pre class="r"><code># Checks by Block
ggplot(zc, aes(x = Block, y = Trait, color = Name)) + 
  geom_beeswarm() + geom_point(data = zbm, color = &quot;black&quot;) +
  #geom_line(aes(group = Name)) +
  geom_hline(yintercept = tot_avg)</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-25-2.png" width="672" /></p>
<pre class="r"><code># Blocks 
ggplot(zz, aes(x = Block, y = `Adjusted Means`, color = Type)) + geom_point()</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-25-3.png" width="672" /></p>
<pre class="r"><code># Trait vs means
ggplot(zz, aes(x = Trait, y = Means, color = Type)) + geom_point()</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-25-4.png" width="672" /></p>
<pre class="r"><code># Trait vs Adjusted Means
# ggplot(zc, aes(x = Trait, y = `Adjusted Means`, color = Type)) + geom_point() + geom_abline()
ggplot(zz, aes(x = Trait, y = `Adjusted Means`, color = Type)) + geom_point() + geom_abline() </code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-25-5.png" width="672" /></p>
<pre class="r"><code># adjustment by block
ggplot(zz, aes(x = Trait, y = Diff, color = Type)) + 
  geom_hline(yintercept = 0) + 
  geom_point() + facet_wrap(Block ~ ., ncol = 5)</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-25-6.png" width="672" /></p>
<pre class="r"><code>#
ggplot(zz, aes(x = `Adjusted Means`, y = AdjMean, color = Type)) + geom_point()</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-25-7.png" width="672" /></p>
<pre class="r"><code>#
xc &lt;- zz %&gt;% filter(Block == 1, Generation == &quot;Check&quot;)
xcmean &lt;- mean(xc$Trait)
xmean &lt;- mean(zz$Trait[zz$Generation == &quot;Check&quot;])
round(xcmean - xc$Trait,2)</code></pre>
<pre><code>## [1] -1.67  0.33  3.33 -1.67 -2.67  2.33</code></pre>
<pre class="r"><code>round(xmean - xc$Trait,2)</code></pre>
<pre><code>## [1] -2.67 -0.67  2.33 -2.67 -3.67  1.33</code></pre>
<pre class="r"><code>(-1.6666667) + (0.3333333) + (3.3333333)+(-1.6666667)+(-2.6666667)+2.3333333</code></pre>
<pre><code>## [1] -2e-07</code></pre>
<pre class="r"><code>0.33+0.33+2.33</code></pre>
<pre><code>## [1] 2.99</code></pre>
<pre class="r"><code>1.67+1.67+2.67</code></pre>
<pre><code>## [1] 6.01</code></pre>
<pre class="r"><code>2.67+0.67+2.67+3.67</code></pre>
<pre><code>## [1] 9.68</code></pre>
<pre class="r"><code>2.33+1.33</code></pre>
<pre><code>## [1] 3.66</code></pre>
<pre class="r"><code>mean(xmean - xc$Trait)</code></pre>
<pre><code>## [1] -1</code></pre>
<pre class="r"><code>out[[5]]</code></pre>
<pre><code>##           1           2           3           4           5           6 
##  0.77277591  0.59143882  1.75810548  0.25810548 -0.24189452 -0.90856118 
##           7           8           9          10          11          12 
## -0.71604662 -1.85785472  0.09143882 -0.24189452 -0.57522785  0.75810548 
##          13          14          15 
##  0.62863177 -1.40856118  1.09143882</code></pre>
<pre class="r"><code>ggplot(xx, aes(x = ))</code></pre>
<pre class="r"><code>xx&lt;-d19
trait &lt;- &quot;DTF&quot;
checks &lt;- paste0(&quot;Check&quot;, 1:6)
augRCBD_analysis &lt;- function(xx, trait) {
  xi &lt;- xx %&gt;% rename(Trait=trait) %&gt;% filter(!is.na(Trait)) %&gt;% # Block %in% 1:3, ,  | Name %in% lines
    mutate(Block = factor(Block), Name = factor(Name))
  #
  out &lt;- augmentedRCBD(block = xi$Block, treatment = xi$Name, y = xi$Trait, checks = checks, 
                       console = F, group = F)
  #
  out2 &lt;- out[[2]]
  colnames(out2)[c(1,3,6,7,8)] &lt;- c(&quot;Name&quot;, paste0(&quot;means_&quot;, trait), paste0(&quot;min_&quot;, trait),
                                    paste0(&quot;max_&quot;, trait), paste0(&quot;Adj_&quot;, trait))
  out2[,c(1,3,6,7,8)] 
}
xx &lt;- d19 %&gt;%
  left_join(augRCBD_analysis(d19, &quot;DTE&quot;), by = &quot;Name&quot;) %&gt;%
  #left_join(augRCBD_analysis(dd, &quot;DTT&quot;), by = &quot;Name&quot;) %&gt;%
  left_join(augRCBD_analysis(d19, &quot;DTF&quot;), by = &quot;Name&quot;) %&gt;%
  left_join(augRCBD_analysis(d19, &quot;DTS&quot;), by = &quot;Name&quot;) %&gt;%
  left_join(augRCBD_analysis(d19, &quot;DTM&quot;), by = &quot;Name&quot;) %&gt;%
  left_join(augRCBD_analysis(d19, &quot;DTH&quot;), by = &quot;Name&quot;) %&gt;%
  left_join(augRCBD_analysis(d19, &quot;VEG&quot;), by = &quot;Name&quot;) %&gt;%
  left_join(augRCBD_analysis(d19, &quot;REP&quot;), by = &quot;Name&quot;)
#
xm &lt;- xx %&gt;% group_by(Population) %&gt;% summarise(Mean = mean(Adj_DTF, na.rm = T)) %&gt;% arrange(Mean)
xr &lt;- xm %&gt;% filter(!Population %in% checks) %&gt;% mutate(Mean = xm$Mean[xm$Population == &quot;Check1&quot;])
xp &lt;- xx %&gt;% filter(Generation == &quot;Parent2&quot;, Name != &quot;PI 426797-1&quot;) %&gt;% arrange(Adj_DTF)
x2 &lt;- xx %&gt;% filter(!Name %in% checks) %&gt;% 
  mutate(Population = factor(Population, levels = paste0(&quot;NAM-&quot;, 1:35)),
         Alpha = ifelse(Name %in% c(d20$Name, checks), &quot;Yes&quot;,&quot;No&quot;))
ggplot(x2, aes(x = Population, y = DTF)) + 
  geom_quasirandom() + 
  geom_point(data = xr, aes(y = Mean), color = &quot;Red&quot;) +
  geom_point(data = xp, color = &quot;darkorange&quot;) +
  theme_dblogr(rotx = T)</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<pre class="r"><code>ggsave(&quot;adj_DTF1.png&quot;,width = 10, height = 4)
ggplot(x2, aes(x = Population, y = Adj_DTF)) + 
  geom_quasirandom() + 
  geom_point(data = xr, aes(y = Mean), color = &quot;Red&quot;) +
  geom_point(data = xp, color = &quot;darkorange&quot;) +
  theme_dblogr(rotx = T)</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-27-2.png" width="672" /></p>
<pre class="r"><code>ggsave(&quot;adj_DTF2.png&quot;,width = 10, height = 4)
ggplot(x2, aes(x = Population, y = Adj_DTF)) + 
  geom_quasirandom(aes(alpha = Alpha)) + 
  geom_point(data = xr, aes(y = Mean), color = &quot;Red&quot;) +
  geom_point(data = xp, color = &quot;darkorange&quot;) +
  theme_dblogr(legend.position = &quot;none&quot;, rotx = T)</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-27-3.png" width="672" /></p>
<pre class="r"><code>ggsave(&quot;adj_DTF3.png&quot;, width = 10, height = 4)
ggplot(x2, aes(x = Population, y = DTF)) + 
  geom_quasirandom(aes(alpha = Alpha)) + 
  geom_point(data = xr, aes(y = Mean), color = &quot;Red&quot;) +
  geom_point(data = xp, color = &quot;darkorange&quot;) +
  theme_dblogr(legend.position = &quot;none&quot;, rotx = T)</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-27-4.png" width="672" /></p>
<pre class="r"><code>ggsave(&quot;adj_DTF3.2.png&quot;, width = 10, height = 4)
ggplot(x2, aes(x = Population, y = Adj_REP)) + 
  geom_quasirandom(aes(alpha = Alpha)) + 
  geom_point(data = xr, aes(y = Mean), color = &quot;Red&quot;) +
  geom_point(data = xp, color = &quot;darkorange&quot;) +
  theme_dblogr(rotx = T)</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-27-5.png" width="672" /></p>
<pre class="r"><code>ggsave(&quot;adj_DTF4.png&quot;,width = 10, height = 4)
ggplot(x2, aes(x = 1, y = Adj_DTF)) + 
  geom_quasirandom() + 
  geom_point(data = xr, aes(y = Mean), color = &quot;Red&quot;) +
  geom_point(data = xp, color = &quot;darkorange&quot;) +
  facet_wrap(.~Population, ncol = 5, scales = &quot;free_x&quot;) +
  theme_dblogr(axis.text.x = element_blank())</code></pre>
<p><img src="/academic_posts/augmented_designs/index_files/figure-html/unnamed-chunk-27-6.png" width="672" /></p>
<pre class="r"><code>ggsave(&quot;adj_DTF5.png&quot;,width = 10, height = 10)</code></pre>
<pre class="r"><code># zc2 &lt;- zz %&gt;% filter(Generation == &quot;Check&quot;) %&gt;% group_by(Block) %&gt;% summarise(Mean = mean(Diff))
# zc2 &lt;- zz %&gt;% filter(Generation == &quot;Check&quot;) %&gt;% select(Name, Block, Trait, Means, `Adjusted Means`)
# zt &lt;- zz %&gt;% filter(Generation == &quot;Check&quot;, Block == 1) %&gt;% mutate(Diff = Trait - tot_avg)
#mean(zt$Diff)
#xi &lt;- xx %&gt;% filter(Block == 1)
#ggplot(xi, aes(x = , ))</code></pre>
<pre class="r"><code>xx &lt;- d19 %&gt;% filter(!is.na(DTF)) %&gt;% mutate(Name = as.character(Name))
aa &lt;- lm(DTF ~ Block + Name, data = xx)
a1 &lt;- data.frame(Name = colnames(aa[[7]]$qr), assign = aa[[6]], Coef = coef(aa)) 
a1 &lt;- a1 %&gt;% filter(assign == 1) %&gt;% 
  separate(Name, c(&quot;Name&quot;, &quot;Block&quot;), sep = &quot;k&quot;) %&gt;% 
  select(Block, Coef) %&gt;% bind_rows(c(15, -sum(a1$Coef)))

a2 &lt;- data.frame(Name = aa$model$Name, Residuals = aa$residuals, Effects = aa$effects, Fitted = aa$fitted.values) #2151
#
a3 &lt;- xx %&gt;% left_join(a2, by = &quot;Name&quot;) %&gt;% left_join(a1, &quot;Block&quot;) %&gt;%
  mutate(AdjMean = ifelse(Generation != &quot;Check&quot;, Fitted - Coef, NA)) %&gt;%
  select(Plot, Name, DTF, Fitted, AdjMean, Coef, Residuals, Effects)
for(i in checks) {
  mn &lt;- mean(a3 %&gt;% filter(Name == i) %&gt;% pull(DTF))
  a3 &lt;- a3 %&gt;% mutate(AdjMean2 = ifelse(Name == i, mn, AdjMean))
}
a4 &lt;- zz %&gt;% left_join(a3, by = &quot;Plot&quot;)
a5 &lt;- a4 %&gt;% filter(Generation == &quot;Check&quot;)
a6 &lt;- a4 %&gt;% mutate(test = round(AdjMean2 - `Adjusted Means`, 1))
ggplot(a4, aes(x = AdjMean2, y = `Adjusted Means`)) + geom_point()</code></pre>
<pre class="r"><code>aa &lt;- aov(DTF ~ Block + Name, data = dd )
#coef(aa)
aa &lt;- lm(DTF ~ Block + Name, data = dd %&gt;% filter(Generation == &quot;Check&quot;))
#coef(aa) 
bb&lt;- residuals(aa)
#fitted.values(aa)
bb &lt;- data.frame(Name = aa$xlevels$Name, aa$residuals)
bb &lt;- dd %&gt;% mutate(Residuals = residuals(aa))
ggplot(dd, aes(x = DTF, y = residuals(aa))) + geom_point()</code></pre>
<pre class="r"><code>checks &lt;- c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;)
xx &lt;- dd %&gt;% filter(!is.na(DTF)) %&gt;% # Block %in% 1:3, ,  | Name %in% lines
  select(Block, Name, DTF) %&gt;%
  mutate(Block = factor(Block), Name = factor(Name))
#
out1 &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$DTF, group = F, method.comp = &quot;lsd&quot;,
              checks = c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;))
#
out2 &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$DTF, group = F, method.comp = &quot;tukey&quot;,
              checks = c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;))
#
out3 &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$DTF, group = F, method.comp = &quot;none&quot;,
              checks = c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;))
#
out1;out2;out3
out1[[5]];out2[[5]];out3[[5]]
out1[[6]]
#
ad &lt;- xx %&gt;% 
  left_join(select(out1[[2]], Name=Treatment, Means, Ad_Mean1=`Adjusted Means`), by = &quot;Name&quot;) %&gt;%
  left_join(select(out2[[2]], Name=Treatment, Ad_Mean2=`Adjusted Means`), by = &quot;Name&quot;) %&gt;%
  left_join(select(out3[[2]], Name=Treatment, Ad_Mean3=`Adjusted Means`), by = &quot;Name&quot;) %&gt;% 
  mutate(Type = ifelse(Name %in% checks, as.character(Name), &quot;Line&quot;))
mp0 &lt;- ggplot(ad, aes(x = DTF, y = Means, color = Type)) +
  geom_abline() + geom_point()
mp1 &lt;- ggplot(ad, aes(x = DTF, y = Ad_Mean1, color = Type)) +
  geom_abline() + geom_point()
mp2 &lt;- ggplot(ad, aes(x = DTF, y = Ad_Mean1, color = Type)) +
  geom_abline() + geom_point()
mp3 &lt;- ggplot(ad, aes(x = DTF, y = Ad_Mean1, color = Type)) +
  geom_abline() + geom_point()
ggpubr::ggarrange(mp0,mp1,mp2,mp3, ncol=4, common.legend = T)</code></pre>
<pre class="r"><code>xx &lt;- dd %&gt;% filter(!is.na(DTF),Block %in% 1:2, grepl(&quot;NAM&quot;, Name) | Name %in% checks) %&gt;% # Block %in% 1:3, ,  | Name %in% lines
  select(Block, Name, DTF) %&gt;%
  mutate(Block = factor(Block), Name = factor(Name))
out &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$DTF,
              checks = c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;))



lines &lt;- c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;,
           &quot;NAM-1-1&quot;,&quot;NAM-1-2&quot;,&quot;NAM-1-4&quot;,&quot;NAM-1-5&quot;,&quot;NAM-1-20&quot;,&quot;NAM-1-40&quot;,
           &quot;NAM-2-20&quot;,&quot;NAM-2-25&quot;,&quot;NAM-2-60&quot;,&quot;NAM-2-86&quot;,&quot;NAM-2-110&quot;,
           &quot;NAM-3-50&quot;,&quot;NAM-3-60&quot;,&quot;NAM-3-70&quot;,&quot;NAM-3-81&quot;,&quot;NAM-3-90&quot;,&quot;NAM-3-100&quot;)
# grepl(&quot;NAM&quot;, dd$Generation)
xx &lt;- dd %&gt;% filter(!is.na(DTF), Block %in% 1:3, Name %in% lines) %&gt;% #  , grepl(&quot;NAM&quot;, Generation) | 
  select(Block, Name, DTF) %&gt;%
  mutate(Block = factor(Block), Name = factor(Name))
out &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$DTF,
              checks = c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;))
#
xx &lt;- dd %&gt;% filter(!is.na(DTF), grepl(&quot;NAM&quot;, Generation) | Name %in% checks) %&gt;% #  ,  | 
  select(Block, Name, DTF) %&gt;%
  mutate(Block = factor(Block), Name = factor(Name))
out &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$DTF,
              checks = c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;))

#

xx &lt;- dd %&gt;% filter(!is.na(DTF), Block %in% 10:13, grepl(&quot;NAM&quot;, Name) | Name %in% checks) %&gt;% #  ,  | 
  select(Block, Name, DTF) %&gt;%
  mutate(Block = factor(Block), Name = factor(Name))
out &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$DTF,
              checks = c(&quot;Check1&quot;, &quot;Check2&quot;, &quot;Check3&quot;, &quot;Check4&quot;, &quot;Check5&quot;, &quot;Check6&quot;))


out &lt;- augmentedRCBD(block = xx$Block, treatment = xx$Name, y = xx$DTF)
#
summary(xx$Name)
#
length(xx$Block)
length(xx$Name)
length(xx$DTF)
sum(is.na(xx$Block))
sum(is.na(xx$Name))
sum(is.na(xx$DTF))</code></pre>
<pre class="r"><code>xx &lt;- dd %&gt;% filter(Block ==1)
xx</code></pre>
<pre class="r"><code>augmentedRCBD &lt;- function(block, treatment, y, checks = NULL,
                          method.comp = c(&quot;lsd&quot;, &quot;tukey&quot;, &quot;none&quot;),
                          alpha=0.05, group=TRUE, console = TRUE,
                          simplify = FALSE, truncate.means = TRUE) {
  # Checks
  # block
  if (!is.factor(block)) {
    stop(&#39;&quot;block&quot; should be of class &quot;factor&quot;&#39;)
  }
  # treatment
  if (!is.factor(treatment)) {
    stop(&#39;&quot;treatment&quot; should be of class &quot;factor&quot;&#39;)
  }
  # y
  if (!(is.vector(y, mode = &quot;integer&quot;) | is.vector(y, mode = &quot;numeric&quot;))) {
    stop(&#39;&quot;y&quot; should be a vector of class &quot;numeric&quot; or &quot;integer&quot;&#39;)
  }
  if (!(length(y) == length(treatment) &amp;&amp; length(treatment) == length(block))) {
    stop(&#39;&quot;block&quot;, &quot;treatment&quot; and &quot;y&quot; are of unequal lengths&#39;)
  }
  if (TRUE %in% is.na(y)) { # check for missing values
    stop(&#39;&quot;y&quot; has missing value(s)&#39;)
  }
  # alpha
  if (!(0 &lt; alpha &amp;&amp; alpha &lt; 1)) {
    stop(&#39;&quot;alpha&quot; should be between 0 and 1 (0 &lt; alpha &lt; 1)&#39;)
  }
  # method.comp
  method.comp &lt;- match.arg(method.comp, c(&quot;lsd&quot;, &quot;tukey&quot;, &quot;none&quot;),
                           several.ok = FALSE)
  if (method.comp == &quot;none&quot;) group &lt;- FALSE
  if (group == FALSE) method.comp &lt;- &quot;none&quot;

  if (!missing(checks) &amp;&amp; !is.null(checks)) {
  #if (!is.null(checks)) {
    checks &lt;- as.character(checks)
    # checks are present in treatment levels
    if (FALSE %in% c(checks %in% levels(treatment))) {
      miss &lt;- paste(checks[!(checks %in% levels(treatment))], collapse = &quot;, &quot;)
      stop(paste(&quot;Following check(s) are not present in treatment levels:\n&quot;,
                    paste(miss, collapse = &quot;, &quot;)))
    }
  }

  # Fix treatment order so that checks are in the beginning
  if (!missing(checks) &amp;&amp; !is.null(checks)) { # i.e. checks are specified
  #if (!is.null(checks)) {
    treatmentorder &lt;- data.frame(table(treatment, block))
    treatmentorder[treatmentorder$Freq != 0, ]$Freq &lt;- 1
    treatmentorder &lt;- reshape2::dcast(treatmentorder, treatment ~ block,
                                      value.var = &quot;Freq&quot;)
    treatmentorder$Freq &lt;- rowSums(subset(treatmentorder,
                                          select = -c(treatment)))
    treatmentorder &lt;- treatmentorder[, c(&quot;treatment&quot;, &quot;Freq&quot;)]

    nblocks &lt;- length(levels(block))
    rownames(treatmentorder) &lt;- NULL

    # check if &quot;checks&quot; are present in all the blocks
    if (!(all(treatmentorder[treatmentorder$treatment %in% checks, ]$Freq == nblocks))) {
      print(treatmentorder)
      stop(paste(&#39;&quot;checks&quot; are not replicated across all the blocks (&#39;,
                 nblocks, &#39;)&#39;, sep = &quot;&quot;))
    }

    tests &lt;- levels(treatment)[!(levels(treatment) %in% checks)]
    if (!all(table(droplevels(treatment[treatment %in% tests])) == 1)) {
      warning(&quot;Test treatments are replicated&quot;)
    }

    nworder &lt;- c(levels(treatmentorder$treatment)[levels(treatmentorder$treatment) %in% checks],
                 tests)
    treatment &lt;- factor(treatment, levels = nworder)

  } else {# i.e. &quot;checks&quot; is not specified
    treatmentorder &lt;- data.frame(table(treatment, block))
    treatmentorder[treatmentorder$Freq != 0, ]$Freq &lt;- 1
    treatmentorder &lt;- reshape2::dcast(treatmentorder, treatment ~ block,
                                      value.var = &quot;Freq&quot;)
    treatmentorder$Freq &lt;- rowSums(subset(treatmentorder,
                                          select = -c(treatment)))
    treatmentorder &lt;- treatmentorder[, c(&quot;treatment&quot;, &quot;Freq&quot;)]
    treatmentorder &lt;- treatmentorder[with(treatmentorder,
                                          order(-Freq, treatment)), ]
    nworder &lt;- treatmentorder$treatment
    treatment &lt;- factor(treatment, levels = treatmentorder$treatment)

    nblocks &lt;- length(levels(block))
    rownames(treatmentorder) &lt;- NULL

    # check if the checks can be inferred.
    # i.e. if any treatments are present in all the blocks
    if (!(nblocks %in% treatmentorder$Freq)) {
      print(treatmentorder)
      stop(paste(&quot;Checks cannot be inferred as none of the treatments are&quot;,
                 &quot;replicated across all the blocks (&quot;,
                 nblocks, &quot;)&quot;, sep = &quot;&quot;))
    }

    checks &lt;- as.character(treatmentorder[treatmentorder$Freq == nblocks, ]$treatment)
    tests &lt;- as.character(treatmentorder[treatmentorder$Freq != nblocks, ]$treatment)

    tests &lt;- levels(treatment)[!(levels(treatment) %in% checks)]
    if (!all(table(droplevels(treatment[treatment %in% tests])) == 1)) {
      warning(&quot;Test treatments are replicated&quot;)
    }
  }


  r &lt;- unique(table(treatment))
  b &lt;- nlevels(block) # no. of blocks
  ntr &lt;- nlevels(treatment)  # no. of treatments

  blockwisechecks &lt;- as.data.frame.matrix(table(treatment, block))
  blockwisechecks &lt;- cbind(treatment = rownames(blockwisechecks),
                           blockwisechecks)
  blockwisechecks &lt;- blockwisechecks[blockwisechecks$treatment %in% checks, ]
  rownames(blockwisechecks) &lt;- NULL

  Details &lt;- list(`Number of blocks` = b, `Number of treatments` = ntr,
                  `Number of check treatments` = length(checks),
                  `Number of test treatments` = length(tests),
                  `Check treatments` =  checks)

  tb &lt;- data.frame(treatment, block)
  tb$block &lt;- as.character(tb$block)
  tb$Block &lt;- ifelse(tb$treatment %in% checks, &quot;&quot;, tb$block)
  tb$block &lt;- NULL
  tb &lt;- unique(tb)

  # Get means table
  Means &lt;- tapply(y, treatment, function(x) mean(x, na.rm = TRUE))
  mi &lt;- tapply(y, treatment, function(x) min(x, na.rm = TRUE))
  ma &lt;- tapply(y, treatment, function(x) max(x, na.rm = TRUE))
  n.rep &lt;- tapply(y, treatment, function(x) length(na.omit(x)))
  sds &lt;- tapply(y, treatment, function(x) sd(x, na.rm = TRUE))
  std.err &lt;- sds / sqrt(n.rep)
  Means &lt;- data.frame(Treatment = names(Means), Means, SE = std.err, r = n.rep,
                      Min = mi, Max = ma)
  Means &lt;- merge(Means, tb, by.x = &quot;Treatment&quot;, by.y = &quot;treatment&quot;)
  Means &lt;- Means[c(&quot;Treatment&quot;, &quot;Block&quot;, &quot;Means&quot;, &quot;SE&quot;, &quot;r&quot;, &quot;Min&quot;, &quot;Max&quot;)]

  # ANOVA 1 - `ANOVA, Treatment Adjusted`
  options(contrasts = c(&quot;contr.helmert&quot;, &quot;contr.poly&quot;))
  augmented.aov &lt;- aov(y ~ block + treatment)

  df.check &lt;- length(checks) - 1
  df.treatment &lt;- length(levels(treatment)) - 1

  A1 &lt;- summary(augmented.aov,
                split = list(treatment = list(Check = 1:df.check,
                                              `Test and Test vs. Check` = (df.check + 1):df.treatment)))

  # Calculate adjusted treatment effects
  options(contrasts = c(&quot;contr.sum&quot;, &quot;contr.poly&quot;))
  augmented3.aov &lt;- aov(y ~ block + treatment)
  co &lt;- coef(augmented3.aov)

  co.treatment &lt;- co[augmented3.aov$assign == 2]
  effects.treatment &lt;- c(co.treatment, -sum(co.treatment))
  names(effects.treatment) &lt;- levels(treatment)
  `Overall adjusted mean` &lt;- co[1]
  names(`Overall adjusted mean`) &lt;- NULL

  # Calculate adjusted block effects
  co.block &lt;- co[augmented3.aov$assign == 1]
  effects.block &lt;- c(co.block, -sum(co.block))
  names(effects.block) &lt;- levels(block)

  # ANOVA 2 - `ANOVA, Block Adjusted`
  contr.augmented &lt;- function(n1, n2){
    m1 &lt;- contr.helmert(n1)
    m2 &lt;- contr.helmert(n2)
    m10 &lt;- cbind(m1, matrix(0, nrow(m1), ncol(m2)))
    m02 &lt;- cbind(matrix(0, nrow(m2), ncol(m1)), m2)
    rbind(m10, m02)
  }

  contrasts(treatment) &lt;- contr.augmented(df.check + 1,
                                          df.treatment - df.check)
  augmented2.aov &lt;- aov(y ~ treatment + block)
  A2 &lt;- summary(augmented2.aov,
                split = list(treatment = list(Check = 1:df.check,
                                              Test = (df.check + 1):(df.treatment - 1),
                                              `Test vs. check` = df.treatment)))

  rownames(A1[[1]])[1] &lt;- &quot;Block (ignoring Treatments)         &quot;
  rownames(A1[[1]])[2] &lt;- &quot;Treatment (eliminating Blocks)      &quot;
  rownames(A1[[1]])[3] &lt;- &quot;  Treatment: Check                  &quot;
  rownames(A1[[1]])[4] &lt;- &quot;  Treatment: Test and Test vs. Check&quot;

  rownames(A2[[1]])[1] &lt;- &quot;Treatment (ignoring Blocks)   &quot;
  rownames(A2[[1]])[2] &lt;- &quot;  Treatment: Check            &quot;
  rownames(A2[[1]])[3] &lt;- &quot;  Treatment: Test             &quot;
  rownames(A2[[1]])[4] &lt;- &quot;  Treatment: Test vs. Check   &quot;
  rownames(A2[[1]])[5] &lt;- &quot;Block (eliminating Treatments)&quot;

  # Adjusted means
  if (method.comp == &quot;none&quot;) {
    mean.adj1 &lt;- data.frame(mean.adj = `Overall adjusted mean` + effects.treatment[1:(df.check + 1)])
    mean.adj1$Treatment &lt;- rownames(mean.adj1)
    mean.adj2 &lt;- data.frame(mean.adj = `Overall adjusted mean` + effects.treatment[(df.check + 2):(df.treatment + 1)])
    mean.adj2$Treatment &lt;- rownames(mean.adj2)
    mean.adj &lt;- rbind(mean.adj1, mean.adj2)

    Means &lt;- merge.data.frame(Means, mean.adj, by = &quot;Treatment&quot;, all = TRUE)

    colnames(Means) &lt;- c(&quot;Treatment&quot;, &quot;Block&quot;, &quot;Means&quot;, &quot;SE&quot;, &quot;r&quot;,
                         &quot;Min&quot;, &quot;Max&quot;, &quot;Adjusted Means&quot;)

  } else {
    LSMeans &lt;- emmeans::emmeans(augmented3.aov, &quot;treatment&quot;)
    LSMeans2 &lt;- summary(LSMeans)[, c(&quot;treatment&quot;, &quot;emmean&quot;)]
    colnames(LSMeans2) &lt;- c(&quot;Treatment&quot;, &quot;Adjusted Means&quot;)

    Means &lt;- merge.data.frame(Means, LSMeans2, by = &quot;Treatment&quot;, all = TRUE)

    colnames(Means) &lt;- c(&quot;Treatment&quot;, &quot;Block&quot;, &quot;Means&quot;, &quot;SE&quot;, &quot;r&quot;,
                         &quot;Min&quot;, &quot;Max&quot;, &quot;Adjusted Means&quot;)
  }

  if (simplify == TRUE) {
    A1 &lt;- data.frame(A1[[1]])
    A1 &lt;- cbind(Source = trimws(rownames(A1)), A1)
    A2 &lt;- data.frame(A2[[1]])
    A2 &lt;- cbind(Source = trimws(rownames(A2)), A2)
    rownames(A1) &lt;- NULL
    rownames(A2) &lt;- NULL
    }

  # Grouping of treatments
  Comparison &lt;- NULL
  Groups &lt;- NULL


  if (group == TRUE) {
    if (method.comp == &quot;lsd&quot;) adjust &lt;- &quot;none&quot;
    if (method.comp == &quot;tukey&quot;) adjust &lt;- &quot;tukey&quot;

    Comparison &lt;- data.frame(summary(pairs(LSMeans, adjust = adjust)))
    Groups &lt;- data.frame(multcomp::cld(LSMeans, adjust = adjust))

    Comparison$sig &lt;- ifelse(Comparison$p.value &lt; 0.001, &quot;***&quot;,
                             ifelse(Comparison$p.value &lt; 0.01, &quot;**&quot;,
                                    ifelse(Comparison$p.value &lt; 0.05, &quot;*&quot;, &quot;&quot;)))
    colnames(Groups) &lt;- c(&quot;Treatment&quot;, &quot;Adjusted Means&quot;, &quot;SE&quot;, &quot;df&quot;,
                          &quot;lower.CL&quot;, &quot;upper.CL&quot;, &quot;Group&quot;)

  }

  # Compute SE and CD for various comparisons
  augmented3.anova &lt;- anova(augmented3.aov)
  MSE &lt;- augmented3.anova[[3]][3]

  CV &lt;- sqrt(MSE) * 100 / mean(augmented3.aov$fitted.values)

  r &lt;- augmented3.anova$Df[1] + 1 # Number of blocks
  c &lt;- length(checks) # Number of check treatments
  t0 &lt;- qt(1 - (alpha / 2), augmented3.aov$df.residual)

  S &lt;- c(&quot;Control Treatment Means&quot;, &quot;Two Test Treatments (Same Block)&quot;,
         &quot;Two Test Treatments (Different Blocks)&quot;,
         &quot;A Test Treatment and a Control Treatment&quot;)

  SE.check &lt;- sqrt(2 * MSE / r) #Two Control Treatments
  SE.test1 &lt;- sqrt(2 * MSE) #Two Augmented Treatments (Same Block)
  SE.test2 &lt;- sqrt(2 * MSE * (1 + (1 / c))) #Two Augmented Treatments(Different Blocks)
  SE.testcheck &lt;- sqrt(MSE * (1 + (1 / r) + (1 / c) + (1 / (r * c)))) #A Test Treatment and a Control Treatment

  SECD &lt;- data.frame(`Std. Error of Diff.` =  c(SE.check, SE.test1,
                                                SE.test2, SE.testcheck),
                     row.names = S, check.names = FALSE)
  SECD$CD &lt;- t0 * SECD$`Std. Error of Diff.`
  colnames(SECD) &lt;- c(&quot;Std. Error of Diff.&quot;,
                      paste(&quot;CD (&quot;, alpha * 100, &quot;%)&quot;, sep = &quot;&quot;))

  if (method.comp == &quot;tukey&quot;) {
    q0 &lt;- qtukey(p = 1 - alpha, nmeans = nlevels(treatment),
                 df = augmented3.aov$df.residual)

    SECD$THSD &lt;- c((q0 * SECD[1:3,]$`Std. Error of Diff.`)/sqrt(2), 0)
    hm &lt;- 4/(1 + (1 / r) + (1 / c) + (1 / (r * c)))
    SECD[4,]$THSD &lt;- q0 * sqrt(MSE/hm)
    colnames(SECD) &lt;- c(&quot;Std. Error of Diff.&quot;,
                        paste(&quot;CD (&quot;, alpha * 100, &quot;%)&quot;, sep = &quot;&quot;),
                        paste(&quot;Tukey HSD (&quot;, alpha * 100, &quot;%)&quot;, sep = &quot;&quot;))
  }

  rm(augmented.aov, augmented2.aov, augmented3.aov, augmented3.anova)

  # Truncate negative adjusted means
  if (any(Means$`Adjusted Means` &lt; 0)){
    negadjmeans &lt;- which(Means$`Adjusted Means` &lt; 0)
    negadjmeanst &lt;- as.character(Means$Treatment[negadjmeans])

    negmsg &lt;- paste(&#39;Negative adjusted means for the following treatment(s)&#39;,
                    &#39;\n&#39;, paste(negadjmeanst, collapse = &quot;, &quot;))

  if (truncate.means == TRUE) {
    Means$`Adjusted Means`[Means$`Adjusted Means` &lt; 0] &lt;- 0
    Groups$`Adjusted Means`[Groups$`Adjusted Means` &lt; 0] &lt;- 0

    warning(paste(negmsg, &#39;\n&#39;,
                  &#39;They were truncated to zero&#39;))
  } else {
    warning(negmsg)
  }
  }

  output &lt;- list(Details = Details, Means = Means,
                 `ANOVA, Treatment Adjusted` = A1,
                 `ANOVA, Block Adjusted` = A2, `Block effects` = effects.block,
                 `Treatment effects` = effects.treatment, `Std. Errors` = SECD,
                 `Overall adjusted mean` = `Overall adjusted mean`,
                 `CV` = CV, `Comparison method` = method.comp,
                 Comparisons = Comparison, Groups = Groups)

  # Set Class
  class(output) &lt;- &quot;augmentedRCBD&quot;

  if (console) {
    print.augmentedRCBD(output)
  }

  return(output)

}</code></pre>
<pre class="r"><code>blk &lt;- c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3)
trt &lt;- c(1, 2, 3, 4, 7, 11, 12, 1, 2, 3, 4, 5, 9, 1, 2, 3, 4, 8, 6, 10)
y1 &lt;- c(92, 79, 87, 81, 96, 89, 82, 79, 81, 81, 91, 79, 78, 83, 77, 78, 78,
        70, 75, 74)
y2 &lt;- c(258, 224, 238, 278, 347, 300, 289, 260, 220, 237, 227, 281, 311, 250,
        240, 268, 287, 226, 395, 450)
# Convert block and treatment to factors
blk &lt;- as.factor(blk)
trt &lt;- as.factor(trt)
#
out1 &lt;- augmentedRCBD(blk, trt, y1, method.comp = &quot;lsd&quot;,
                      alpha = 0.05, group = TRUE, console = TRUE)
out1&lt;-out
out1[[1]]  # details
out1[[2]]  # adjusted means
out1[[3]]  # ANOVA treatment adjusted
out1[[4]]  # ANOVA block adjusted
out1[[5]]  # block effects
out1[[6]]  # treatment effects
out1[[7]]  # standard errors
out1[[8]]  # overall adjusted mean
out1[[9]]  # CV
out1[[10]] # Comparison Method
out1[[11]] # Comparisons
out1[[12]] # Groups</code></pre>
</div>
