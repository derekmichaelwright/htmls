---
title: "Explaining Correlation Coefficients"
subtitle: "A quick explanation of how to properly use correlation coefficients when evaluating models"
summary:  "A quick explanation of how to properly use correlation coefficients when evaluating models"
author: "Derek Michael Wright <derek.wright@usask.ca> [www.dblogr.com/](https://dblogr.netlify.com/)"
date: "2020-01-02"
categories: [ "Academic" ]
tags: [ "Academic", "AGILE", "Tutorials", "Featured" ]
math: true
image:
  preview_only: yes
links:
  - icon_pack: fas
    icon: chart-line
    name: All Graphs
    url: academic_graphs/correlation_coefficients
  - icon: file-code
    icon_pack: far
    name: HTML
    url: https://derekmichaelwright.github.io/htmls/academic/correlation_coefficients.html
  - icon: file-pdf
    icon_pack: far
    name: PDF (Save/Print)
    url: academic_pdfs/correlation_coefficients.pdf
---



<hr />
<pre class="r"><code># devtools::install_github(&quot;derekmichaelwright/dblogr&quot;)
library(dblogr) # Loads: tidyverse, ggpubr, ggbeeswarm, ggrepel
library(ggpmisc) # stat_poly_eq()</code></pre>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>The correlation coefficient (<em>R<sup>2</sup></em>), which indicates the proportion of variation explained by an independant variable or model, can be calculated in more than one way. The goal of this vignette is to help clear up this confusion, with a few different examples.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="load-dataset-1" class="section level1">
<h1>Load Dataset 1</h1>
<p><code>d1</code></p>
<ul>
<li><code>Entry</code>: 1 Lentil Genotype</li>
<li><code>Expt</code>: 18 Site-years</li>
<li><code>MacroEnv</code>: 3 Macroenvironments</li>
<li><code>Rep</code>: 1-3 Reps per site-year</li>
<li><code>T_mean</code>: Mean temperature</li>
<li><code>P_mean</code>: Mean photoperiod</li>
<li><code>DTF</code>: Days from sowing to flower</li>
<li><code>DTM</code>: Days from sowing to swollen pod</li>
<li><code>DTM</code>: Days from sowing to maturity</li>
<li><code>RDTF</code>: Rate of progress towards fowering</li>
</ul>
<pre class="r"><code># Prep data
d1 &lt;- read.csv(&quot;Data_1.csv&quot;) %&gt;% 
  mutate(RDTF = 1 / DTF) # Rate of progress towards fowering
# Preview data
knitr::kable(d1[c(1:3,31:33,49:51),])</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Entry</th>
<th align="left">Expt</th>
<th align="left">MacroEnv</th>
<th align="right">Rep</th>
<th align="right">T_mean</th>
<th align="right">P_mean</th>
<th align="right">DTF</th>
<th align="right">DTS</th>
<th align="right">DTM</th>
<th align="right">RDTF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">33</td>
<td align="left">Ro16</td>
<td align="left">Macroenvironment 1</td>
<td align="right">1</td>
<td align="right">17.2</td>
<td align="right">16.2</td>
<td align="right">45</td>
<td align="right">62</td>
<td align="right">96</td>
<td align="right">0.0222222</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">33</td>
<td align="left">Ro16</td>
<td align="left">Macroenvironment 1</td>
<td align="right">2</td>
<td align="right">17.2</td>
<td align="right">16.2</td>
<td align="right">44</td>
<td align="right">64</td>
<td align="right">96</td>
<td align="right">0.0227273</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">33</td>
<td align="left">Ro16</td>
<td align="left">Macroenvironment 1</td>
<td align="right">3</td>
<td align="right">17.2</td>
<td align="right">16.2</td>
<td align="right">44</td>
<td align="right">61</td>
<td align="right">92</td>
<td align="right">0.0227273</td>
</tr>
<tr class="even">
<td align="left">31</td>
<td align="right">33</td>
<td align="left">Ne16</td>
<td align="left">Macroenvironment 2</td>
<td align="right">1</td>
<td align="right">19.2</td>
<td align="right">11.0</td>
<td align="right">81</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.0123457</td>
</tr>
<tr class="odd">
<td align="left">32</td>
<td align="right">33</td>
<td align="left">Ne16</td>
<td align="left">Macroenvironment 2</td>
<td align="right">2</td>
<td align="right">19.2</td>
<td align="right">11.0</td>
<td align="right">77</td>
<td align="right">111</td>
<td align="right">124</td>
<td align="right">0.0129870</td>
</tr>
<tr class="even">
<td align="left">33</td>
<td align="right">33</td>
<td align="left">Ne16</td>
<td align="left">Macroenvironment 2</td>
<td align="right">3</td>
<td align="right">19.2</td>
<td align="right">11.0</td>
<td align="right">82</td>
<td align="right">106</td>
<td align="right">121</td>
<td align="right">0.0121951</td>
</tr>
<tr class="odd">
<td align="left">49</td>
<td align="right">33</td>
<td align="left">It16</td>
<td align="left">Macroenvironment 3</td>
<td align="right">1</td>
<td align="right">10.6</td>
<td align="right">10.8</td>
<td align="right">114</td>
<td align="right">130</td>
<td align="right">164</td>
<td align="right">0.0087719</td>
</tr>
<tr class="even">
<td align="left">50</td>
<td align="right">33</td>
<td align="left">It16</td>
<td align="left">Macroenvironment 3</td>
<td align="right">2</td>
<td align="right">10.6</td>
<td align="right">10.8</td>
<td align="right">114</td>
<td align="right">133</td>
<td align="right">175</td>
<td align="right">0.0087719</td>
</tr>
<tr class="odd">
<td align="left">51</td>
<td align="right">33</td>
<td align="left">It16</td>
<td align="left">Macroenvironment 3</td>
<td align="right">3</td>
<td align="right">10.6</td>
<td align="right">10.8</td>
<td align="right">120</td>
<td align="right">145</td>
<td align="right">168</td>
<td align="right">0.0083333</td>
</tr>
</tbody>
</table>
<p><a href="https://github.com/derekmichaelwright/myblog/tree/master/content/dblogr_posts/correlation_coefficients/Data_1.csv"><em>Table 1: Correlation data set #1 (d1).</em></a></p>
</div>
<div id="correlation-between-two-traits" class="section level1">
<h1>Correlation Between Two Traits</h1>
<p>The most obvious correlation is that of two traits. For example, since <code>DTF</code>, <code>DTS</code>, and <code>DTM</code> are all phenology traits, we can assume they will be highly correlated. Lets plot this out and see how it looks.</p>
<pre class="r"><code># Remove any rows with missing data
d1 &lt;- d1 %&gt;% filter(!is.na(DTF), !is.na(DTS), !is.na(DTM))
# DTF - DTS
mp1 &lt;- ggplot(d1, aes(x = DTF, y = DTS)) + 
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;red&quot;) + 
  geom_point(aes(fill = MacroEnv), size = 3, pch = 21, alpha = 0.7) + 
  scale_fill_manual(name = NULL, values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = &quot;*\&quot;,\&quot;~~&quot;)),
               formula = y ~ x, parse = T, rr.digits = 3) +
  theme_dblogr(legend.position = &quot;top&quot;) +
  labs(x = &quot;Days to Flower&quot;, y = &quot;Days to Swollen Pods&quot;)
# DTS - DTM
mp2 &lt;- ggplot(d1, aes(x = DTS, y = DTM)) + 
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;red&quot;) + 
  geom_point(aes(fill = MacroEnv), size = 3, pch = 21, alpha = 0.7) + 
  scale_fill_manual(name = NULL, values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = &quot;*\&quot;,\&quot;~~&quot;)),
               formula = y ~ x, parse = T, rr.digits = 3) +
  theme_dblogr(legend.position = &quot;top&quot;) +
  labs(x = &quot;Days to Swollen Pods&quot;, y = &quot;Days to Maturity&quot;)
# DTF - DTM
mp3 &lt;- ggplot(d1, aes(x = DTF, y = DTM)) + 
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;red&quot;) + 
  geom_point(aes(fill = MacroEnv), size = 3, pch = 21, alpha = 0.7) + 
  scale_fill_manual(name = NULL, values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = &quot;*\&quot;,\&quot;~~&quot;)),
               formula = y ~ x, parse = T, rr.digits = 3) +
  theme_dblogr(legend.position = &quot;top&quot;) +
  labs(x = &quot;Days to Flower&quot;, y = &quot;Days to Maturity&quot;,
       caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
# Append and Save
mp &lt;- ggarrange(mp1, mp2, mp3, nrow = 1, common.legend = T, align = &quot;h&quot;)
ggsave(&quot;corr_coef_01.png&quot;, mp, width = 10, height = 4)</code></pre>
<p><img src="corr_coef_01.png" /></p>
<p><strong>Interpretations</strong>:</p>
<ul>
<li>88.3% of variation in <code>DTS</code> is explained by <code>DTF</code>.</li>
<li>92.7% of variation in <code>DTM</code> is explained by <code>DTS</code>.</li>
<li>88.7% of variation in <code>DTM</code> is explained by <code>DTF</code>.</li>
</ul>
<div style="page-break-after: always;"></div>
</div>
<div id="calculating-r2" class="section level1">
<h1>Calculating <em>R<sup>2</sup></em></h1>
<div id="pearsons-r2" class="section level2">
<h2><em>Pearson’s R<sup>2</sup></em></h2>
<p><em>R<sup>2</sup></em> can be calculated using the <code>cor</code> function which has <code>method = "pearson"</code> as the default.</p>
<pre class="r"><code>cor(x = d1$DTF, y = d1$DTS, method = &quot;pearson&quot;)^2</code></pre>
<pre><code>## [1] 0.8833893</code></pre>
<pre class="r"><code>cor(x = d1$DTS, y = d1$DTM, method = &quot;pearson&quot;)^2</code></pre>
<pre><code>## [1] 0.9272951</code></pre>
<pre class="r"><code>cor(x = d1$DTF, y = d1$DTM, method = &quot;pearson&quot;)^2</code></pre>
<pre><code>## [1] 0.8868398</code></pre>
<p><em>R<sup>2</sup></em> can also be manually calculated using the following formula to calculate <em>Pearson’s r</em>:</p>
<p><span class="math inline">\(r=\frac{n\sum xy - (\sum x)(\sum y)}{\sqrt{(n\sum x^2 - (\sum x)^2)(n\sum y^2 - (\sum y)^2)}}\)</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(x\)</span> = Independant variable</li>
<li><span class="math inline">\(y\)</span> = Dependant Variable</li>
<li><span class="math inline">\(n\)</span> = Number of observations</li>
</ul>
<p>and</p>
<p><span class="math inline">\(R^2=r^2\)</span></p>
<p>Now lets manually create a function to calculate <em>R<sup>2</sup></em> using <em>Pearson’s r</em>.</p>
<pre class="r"><code>pearsonsR2 &lt;- function(x, y) {
  n &lt;- length(x)
  r_numerator &lt;- n * sum(x*y) - sum(x) * sum(y)
  r_denominator &lt;- sqrt( (n * sum(x^2) - sum(x)^2) * (n * sum(y^2) - sum(y)^2) )
  r &lt;- r_numerator / r_denominator
  r^2
}
pearsonsR2(x = d1$DTF, y = d1$DTS)</code></pre>
<pre><code>## [1] 0.8833893</code></pre>
<pre class="r"><code>pearsonsR2(x = d1$DTS, y = d1$DTM)</code></pre>
<pre><code>## [1] 0.9272951</code></pre>
<pre class="r"><code>pearsonsR2(x = d1$DTF, y = d1$DTM)</code></pre>
<pre><code>## [1] 0.8868398</code></pre>
<p>Switching the <code>x</code> and <code>y</code> variables gives the same result.</p>
<pre class="r"><code>pearsonsR2(x = d1$DTM, y = d1$DTF)</code></pre>
<pre><code>## [1] 0.8868398</code></pre>
<pre class="r"><code>cor(x = d1$DTM, y = d1$DTF, method = &quot;pearson&quot;)^2</code></pre>
<pre><code>## [1] 0.8868398</code></pre>
<p>Note that the <code>stat_poly_eq</code> function included the option <code>formula = y ~ x</code>, which creates a linear regression of the <code>x</code> and <code>y</code> variables. Our <em>R<sup>2</sup></em> is a measure how how well the <code>DTM</code> data matches the <em>predictions of DTM</em> based on our <code>DTF</code> data and linear regression model.</p>
<pre class="r"><code># Perform linear regression
myModel &lt;- lm(DTM ~ DTF, data = d1)
summary(myModel)</code></pre>
<pre><code>## 
## Call:
## lm(formula = DTM ~ DTF, data = d1)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -21.443  -6.744  -1.465   5.132  23.879 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 47.91678    3.82211   12.54 2.78e-16 ***
## DTF          0.95699    0.05096   18.78  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 9.601 on 45 degrees of freedom
## Multiple R-squared:  0.8868, Adjusted R-squared:  0.8843 
## F-statistic: 352.7 on 1 and 45 DF,  p-value: &lt; 2.2e-16</code></pre>
<pre class="r"><code>summary(myModel)$r.squared</code></pre>
<pre><code>## [1] 0.8868398</code></pre>
<pre class="r"><code># Get predicted values and residual values from model
d1 &lt;- d1 %&gt;% mutate(Predicted_DTM = predict(myModel), 
                    Residuals_DTM = residuals(myModel) )</code></pre>
<p>We can also calculate <em>R<sup>2</sup></em> by replacing <code>DTF</code> with with the <code>Predicted_DTM</code> values from our linear regression model.</p>
<pre class="r"><code>pearsonsR2(x = d1$Predicted_DTM, y = d1$DTM)</code></pre>
<pre><code>## [1] 0.8868398</code></pre>
<p>Again, switching the x and y variables gives the same result.</p>
<pre class="r"><code>pearsonsR2(x = d1$DTM, y = d1$Predicted_DTM)</code></pre>
<pre><code>## [1] 0.8868398</code></pre>
</div>
<div id="sum-of-squares-r2" class="section level2">
<h2><em>Sum of Squares R<sup>2</sup></em></h2>
<p>If you have <em>Observed</em> and <em>Predicted</em> values, <em>R<sup>2</sup></em> can also be calculated using the <em>Sum of Squares</em> formula:</p>
<p><span class="math inline">\(R^2=1-\frac{SS_{residuals}}{SS_{total}}=1-\frac{\sum (o-p)^2}{\sum (o-\bar{o})^2}\)</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(o\)</span> = Observed value</li>
<li><span class="math inline">\(p\)</span> = Predicted value</li>
<li><span class="math inline">\(\bar{o}=\frac{\sum o}{n}\)</span> = Mean of observed values</li>
</ul>
<p>Now lets manually create a function to calculate <em>R<sup>2</sup></em> using the <em>Sum of Squares</em>.</p>
<pre class="r"><code>SumOfSquaresR2 &lt;- function(o, p) { 1 - ( sum((o - p)^2) / sum((o - mean(o))^2) ) }</code></pre>
<p>Create a plot to visualize the <em>Total Sum of Squares</em> and <em>Residual Sum of Squares</em></p>
<pre class="r"><code># Prep data
xx &lt;- d1 %&gt;% filter(Expt %in% c(&quot;Ro17&quot;,&quot;Ne17&quot;,&quot;Sp17&quot;,&quot;It17&quot;), Rep == 2)
# Total Sum of Squares Plot
mp1 &lt;- ggplot(xx, aes(x = DTF, y = DTM)) +
  geom_text(x = 40, y = 120, size = 5, label = expression(italic(bar(&quot;y&quot;))), parse = T) +
  geom_rect(alpha = 0.3, fill = &quot;coral&quot;, color = alpha(&quot;black&quot;,0.5),
            aes(xmin = DTF, xmax = DTF + (mean(d1$DTM, na.rm = T) - DTM), 
                ymin = DTM, ymax = mean(d1$DTM, na.rm = T))) +
  geom_hline(yintercept = mean(d1$DTM, na.rm = T), color = &quot;coral&quot;) +
  geom_point(size = 2, ) + 
  geom_point(data = d1,alpha = 0.3) +
  theme_dblogr() +
  labs(title = &quot;(a) Total Sum of Squares&quot;)
# Residual Sum of Squares Plot
mp2 &lt;- ggplot(xx, aes(x = DTF, y = DTM)) + 
  geom_text(x = 70, y = 120, size = 5, label = expression(italic(&quot;f&quot;)), parse = T) +
  geom_rect(alpha = 0.3, fill = &quot;darkorchid&quot;, color = alpha(&quot;black&quot;,0.5),
            aes(xmin = DTF, xmax = DTF - Residuals_DTM, 
                ymin = DTM, ymax = Predicted_DTM)) +
  geom_smooth(data = d1, method = &quot;lm&quot;, se = F, color = &quot;darkorchid&quot;) +
  geom_point(size = 2) + 
  geom_point(data = d1, alpha = 0.3) +
  theme_dblogr() +
  labs(title = &quot;(b) Residual Sum of Squares&quot;,
       caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
# Appened
mp &lt;- ggarrange(mp1, mp2, ncol = 2, align = &quot;h&quot;)
ggsave(&quot;corr_coef_02.png&quot;, mp, width = 8, height = 4)</code></pre>
<p><img src="corr_coef_02.png" /></p>
<div style="page-break-after: always;"></div>
<p>In this case:</p>
<ul>
<li><span class="math inline">\(o\)</span> = Observed value = <code>DTM</code></li>
<li><span class="math inline">\(p\)</span> = Predicted value = <code>Predicted_DTM</code></li>
<li><span class="math inline">\(\bar{o}\)</span> = Mean of observed values = <code>mean(DTM, na.rm = T)</code></li>
</ul>
<p>Now lets calculate <em>R<sup>2</sup></em> using the <em>Sum of Squares</em> formula.</p>
<pre class="r"><code>SumOfSquaresR2(o = d1$DTM, p = d1$Predicted_DTM)</code></pre>
<pre><code>## [1] 0.8868398</code></pre>
<p>Now, Swaping the <code>x</code> and <code>y</code> variables results in different values. <strong>Why?</strong></p>
<pre class="r"><code>SumOfSquaresR2(p = d1$DTM, o = d1$Predicted_DTM)</code></pre>
<pre><code>## [1] 0.8724006</code></pre>
<p>It is important to set <code>DTM</code> as the <em>observed</em> variable and <code>Predicted_DTM</code> as the <em>predicted</em> variable. This is becuase with the sum of squares model, our trendline has a <code>slope = 1</code> and <code>intercept = 0</code> (<code>geom_abline</code>), which is matched by <code>lm(DTM~Predicted_DTM)</code> but not <code>lm(Predicted_DTM~DTM)</code>.</p>
<pre class="r"><code># Intercept = 0, Slope = 1
round(lm(DTM ~ Predicted_DTM, data = d1)$coefficients, 3)</code></pre>
<pre><code>##   (Intercept) Predicted_DTM 
##             0             1</code></pre>
<pre class="r"><code># Intercept != 0, Slope != 1
round(lm(Predicted_DTM ~ DTM, data = d1)$coefficients, 3)</code></pre>
<pre><code>## (Intercept)         DTM 
##      12.980       0.887</code></pre>
<p>This can be visualized by showing how the trendline (<code>geom_smooth(method = "lm")</code>) devaites from the 1:1 line (<code>geom_abline()</code>).</p>
<pre class="r"><code>mymin &lt;- min(c(d1$DTM, d1$Predicted_DTM))
mymax &lt;- max(c(d1$DTM, d1$Predicted_DTM))
mp1 &lt;- ggplot(d1, aes(y = DTM, x = Predicted_DTM)) + 
  geom_smooth(method = &quot;lm&quot;, se = F, size = 2, color = &quot;red&quot;) + 
  geom_abline(color = &quot;blue&quot;) +
  geom_point(aes(fill = MacroEnv), size = 3, pch = 21, alpha = 0.7) +
  scale_fill_manual(values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  xlim(c(mymin, mymax)) + ylim(c(mymin, mymax)) +
  theme_dblogr()
mp2 &lt;- ggplot(d1, aes(x = DTM, y = Predicted_DTM)) + 
  geom_smooth(method = &quot;lm&quot;, formula = y ~ x, se = F, size = 2, color = &quot;red&quot;) + 
  geom_abline(color = &quot;blue&quot;) + 
  geom_point(aes(fill = MacroEnv), size = 3, pch = 21, alpha = 0.7) +
  scale_fill_manual(values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  xlim(c(mymin, mymax)) + ylim(c(mymin, mymax)) +
  theme_dblogr() +
  labs(caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
mp &lt;- ggarrange(mp1, mp2, ncol = 2, legend = &quot;none&quot;, align = &quot;h&quot;)
ggsave(&quot;corr_coef_03.png&quot;, mp, width = 8, height = 4)</code></pre>
<p><img src="corr_coef_03.png" /></p>
<p><strong>Why is this important?</strong> Improper usage can lead to inncorrect interpretations. The example above involved inncorrectly calculating <em>R<sup>2</sup></em> by swapping our observed and predicted variables within the <em>Sum of Squares</em> (<em>SS</em>) formula. Another example would be using the <em>Sum of Squares</em> formula without predictions vs. observations. <em>E.g.,</em> if we calculate <em>R<sup>2</sup></em> using our <code>SumOfSquaresR2</code> function with <code>DTF</code> vs <code>DTM</code>.</p>
<pre class="r"><code>SumOfSquaresR2(o = d1$DTF, p = d1$DTM)</code></pre>
<pre><code>## [1] -1.789874</code></pre>
<pre class="r"><code>mymin &lt;- min(d1$DTF)
mymax &lt;- max(d1$DTM)
mp1 &lt;- ggplot(d1, aes(x = DTF, y = DTM)) +
  geom_abline(color = &quot;blue&quot;) +
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;red&quot;) + 
  geom_segment(aes(xend = DTF, yend = Predicted_DTM)) +
  geom_point(aes(fill = MacroEnv), size = 3, pch = 21, alpha = 0.7) +
  scale_fill_manual(values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  xlim(c(mymin, mymax)) + ylim(c(mymin, mymax)) +
  theme_dblogr() +
  labs(title = substitute(paste(&quot;A) &quot;, italic(&quot;Pearson&#39;s R&quot;)^2, &quot; = &quot;, r2), 
         list(r2 = round(pearsonsR2(x = d1$DTF, y = d1$DTM), 3))))
mp2 &lt;- ggplot(d1, aes(x = DTF, y = DTM)) +
  geom_abline(color = &quot;blue&quot;) +
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;red&quot;) + 
  geom_segment(aes(xend = DTF, yend = DTF)) +
  geom_point(aes(fill = MacroEnv), size = 3, pch = 21, alpha = 0.7) +
  scale_fill_manual(values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  xlim(c(mymin, mymax)) + ylim(c(mymin, mymax)) +
  theme_dblogr() +
  labs(title = substitute(paste(&quot;B) &quot;, italic(&quot;Sum of Squares R&quot;)^2, &quot; = &quot;, r2), 
         list(r2 = round(SumOfSquaresR2(o = d1$DTF, p = d1$DTM), 3))),
       caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
mp &lt;- ggarrange(mp1, mp2, nrow= 1, ncol = 2, legend = &quot;none&quot;, align = &quot;h&quot;)
ggsave(&quot;corr_coef_04.png&quot;, mp, width = 8, height = 4)</code></pre>
<p><img src="corr_coef_04.png" /></p>
<p>However, the more common mistake happens when the <em>Pearson’s</em> formula is used for evaluating the accuracy of a model used to predict values.</p>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="load-dataset-2" class="section level1">
<h1>Load Dataset 2</h1>
<p><code>d2</code></p>
<ul>
<li><code>Entry</code>: 324 Genotypes</li>
<li><code>Expt</code>: 3 Site-years</li>
<li><code>MacroEnv</code>: 3 Macroenvironments</li>
<li><code>DTF</code>: Days from sowing to flower</li>
<li><code>Predicted_DTF</code>: Predicted values of DTF</li>
</ul>
<pre class="r"><code># Prep data
d2 &lt;- read.csv(&quot;Data_2.csv&quot;) %&gt;%
  mutate(Expt = factor(Expt, levels = c(&quot;Su16&quot;, &quot;Ne16&quot;, &quot;It16&quot;)))
# Preview data
knitr::kable(d2[c(1:3,478:480,970:972),])</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Entry</th>
<th align="left">Expt</th>
<th align="left">MacroEnv</th>
<th align="right">DTF</th>
<th align="right">Predicted_DTF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">1</td>
<td align="left">Su16</td>
<td align="left">Macroenvironment 1</td>
<td align="right">53.66667</td>
<td align="right">51.58706</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">1</td>
<td align="left">Ne16</td>
<td align="left">Macroenvironment 2</td>
<td align="right">123.00000</td>
<td align="right">97.99714</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">1</td>
<td align="left">It16</td>
<td align="left">Macroenvironment 3</td>
<td align="right">136.66667</td>
<td align="right">145.02877</td>
</tr>
<tr class="even">
<td align="left">478</td>
<td align="right">160</td>
<td align="left">Su16</td>
<td align="left">Macroenvironment 1</td>
<td align="right">53.33333</td>
<td align="right">50.77359</td>
</tr>
<tr class="odd">
<td align="left">479</td>
<td align="right">160</td>
<td align="left">Ne16</td>
<td align="left">Macroenvironment 2</td>
<td align="right">125.00000</td>
<td align="right">100.79214</td>
</tr>
<tr class="even">
<td align="left">480</td>
<td align="right">160</td>
<td align="left">It16</td>
<td align="left">Macroenvironment 3</td>
<td align="right">134.00000</td>
<td align="right">136.28517</td>
</tr>
<tr class="odd">
<td align="left">970</td>
<td align="right">324</td>
<td align="left">Su16</td>
<td align="left">Macroenvironment 1</td>
<td align="right">50.66667</td>
<td align="right">48.10054</td>
</tr>
<tr class="even">
<td align="left">971</td>
<td align="right">324</td>
<td align="left">Ne16</td>
<td align="left">Macroenvironment 2</td>
<td align="right">130.66667</td>
<td align="right">98.00611</td>
</tr>
<tr class="odd">
<td align="left">972</td>
<td align="right">324</td>
<td align="left">It16</td>
<td align="left">Macroenvironment 3</td>
<td align="right">125.33333</td>
<td align="right">129.47559</td>
</tr>
</tbody>
</table>
<p><a href="https://github.com/derekmichaelwright/myblog/tree/master/content/dblogr_posts/correlation_coefficients/Data_2.csv"><em>Table 2: Correlation data set #2 (d2).</em></a></p>
<pre class="r"><code>mymin &lt;- min(c(d2$DTF, d2$Predicted_DTF))
mymax &lt;- max(c(d2$DTF, d2$Predicted_DTF))
mp &lt;- ggplot(d2, aes(x = Predicted_DTF, y = DTF)) + 
  geom_point(aes(color = MacroEnv), alpha = 0.3) + 
  geom_abline(color = &quot;blue&quot;) + 
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;red&quot;) +
  facet_wrap(Expt~., scales = &quot;free&quot;, ncol = 3) +
  stat_poly_eq(formula = y ~ x, parse = T, rr.digits = 7) +
  scale_color_manual(values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  xlim(c(mymin, mymax)) + ylim(c(mymin, mymax)) +
  theme_dblogr(legend.position = &quot;none&quot;) +
  labs(title = expression(paste(&quot;Incorrect usage of &quot;, italic(&quot;Pearson&#39;s R&quot;)^2)),
       caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
ggsave(&quot;corr_coef_05.png&quot;, mp, width = 8, height = 4)</code></pre>
<p><img src="corr_coef_05.png" /></p>
<pre class="r"><code>my_ggplot &lt;- function(expt, color) {
  # Prep data
  xx &lt;- d2 %&gt;% filter(Expt == expt) 
  xx &lt;- xx %&gt;%
    mutate(Trendline = predict(lm(DTF ~ Predicted_DTF, data = xx)))
  mymin &lt;- min(c(xx$DTF, xx$Predicted_DTF))
  mymax &lt;- max(c(xx$DTF, xx$Predicted_DTF))
  # Plot
  mp1 &lt;- ggplot(xx, aes(x = Predicted_DTF, y = DTF)) + 
    geom_segment(aes(xend = Predicted_DTF, yend = Trendline), alpha = 0.2) +
    geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;red&quot;) +
    geom_point(color = color, alpha = 0.5) + 
    geom_abline(color = &quot;blue&quot;) +
    xlim(c(mymin, mymax)) + ylim(c(mymin, mymax)) +
    theme_dblogr() +
    labs(title = expt,
         subtitle = substitute(paste(italic(&quot;Pearson&#39;s R&quot;)^2, &quot; = &quot;, r2), 
           list(r2 = round(pearsonsR2(x = xx$DTF, y = xx$Predicted_DTF), 3))))
  mp2 &lt;- ggplot(xx, aes(x = Predicted_DTF, y = DTF)) + 
    geom_segment(aes(xend = Predicted_DTF, yend = Predicted_DTF), alpha = 0.2) +
    geom_point(color = color, alpha = 0.5) + 
    geom_abline(color = &quot;blue&quot;) +
    stat_poly_eq(formula = y ~ x, parse = T, rr.digits = 7) +
    xlim(c(mymin, mymax)) + ylim(c(mymin, mymax)) +
    theme_dblogr() +
    labs(subtitle = substitute(paste(italic(&quot;Sum of Squares R&quot;)^2, &quot; = &quot;, r2), 
           list(r2 = round(SumOfSquaresR2(o = xx$DTF, p = xx$Predicted_DTF), 3))),
         caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
  ggarrange(mp1, mp2, ncol = 2, align = &quot;h&quot;)
}</code></pre>
<pre class="r"><code>mp1 &lt;- my_ggplot(&quot;Su16&quot;, color = &quot;darkgreen&quot;)
mp2 &lt;- my_ggplot(&quot;Ne16&quot;, color = &quot;darkorange&quot;)
mp3 &lt;- my_ggplot(&quot;It16&quot;, color = &quot;darkblue&quot;)
mp &lt;- ggarrange(mp1, mp2, mp3, ncol = 1)
ggsave(&quot;corr_coef_06.png&quot;, mp, width = 8, height = 10)</code></pre>
<p><img src="corr_coef_06.png" /></p>
</div>
<div id="negative-r2-values" class="section level1">
<h1>Negative <em>R<sup>2</sup></em> values</h1>
<p>Using <em>Pearson’s</em> formula <em>R<sup>2</sup></em> values will always fall between 0 and 1. However, when using the <em>Sum of Squares</em> formula (which has an intercept of 0), negative values can be aquired.</p>
<pre class="r"><code># Calculate R^2 for Ne17
xx &lt;- d2 %&gt;% filter(Expt == &quot;Ne16&quot;)
SumOfSquaresR2(o = xx$DTF, p = xx$Predicted_DTF)</code></pre>
<pre><code>## [1] -2.581473</code></pre>
<p><em>R<sup>2</sup></em> for <code>Ne17</code> is &lt; 0, What does this mean? and how do we interpret it?</p>
<p><em>R<sup>2</sup></em> = 1 = regression is perfect, no errors</p>
<p>since,</p>
<p><span class="math inline">\(R^2=1-\frac{SS_{residuals}}{SS_{total}}=1-\frac{0}{\sum (x-\bar{x})}=1\)</span></p>
<pre class="r"><code># Calculate R^2 of perfect regression
SumOfSquaresR2(o = xx$DTF, p = xx$DTF)</code></pre>
<pre><code>## [1] 1</code></pre>
<p><em>R<sup>2</sup></em> = 0 = regression is no better than using the mean</p>
<p>since,</p>
<p><span class="math inline">\(y=\bar{x}\)</span></p>
<p>and,</p>
<p><span class="math inline">\(R^2=1-\frac{SS_{residuals}}{SS_{total}}=1-\frac{\sum (x-\bar{x})}{\sum (x-\bar{x})}=1-1=0\)</span></p>
<pre class="r"><code># Prep data
xx &lt;- xx %&gt;% mutate(Mean_DTF = mean(DTF))
# Calculate R^2 with mean
SumOfSquaresR2(o = xx$DTF, p = xx$Mean_DTF)</code></pre>
<pre><code>## [1] 0</code></pre>
<p><em>R<sup>2</sup></em> &lt; 0 = regression is worse than using the mean.</p>
<p><span class="math inline">\(R^2=1-\frac{SS_{residuals}}{SS_{total}}=1-(&gt;1)=(&lt;0)\)</span></p>
<pre class="r"><code># Calculate the Sum of Squares for the residuals
sum((xx$DTF - xx$Predicted_DTF)^2)</code></pre>
<pre><code>## [1] 226005</code></pre>
<pre class="r"><code># Calculate the total Sum of Squares
sum((xx$DTF - mean(xx$DTF))^2)</code></pre>
<pre><code>## [1] 63103.93</code></pre>
<p><span class="math inline">\(SS_{residuals} &gt; SS_{total}\)</span></p>
<pre class="r"><code>t1 &lt;- paste(&quot;Total Sum of Squares =&quot;, round(sum((xx$DTF - mean(xx$DTF))^2)))
t2 &lt;- paste(&quot;Residual Sum of Squares =&quot;, round(sum((xx$DTF - xx$Predicted_DTF)^2)))
mp1 &lt;- ggplot(xx, aes(x = Predicted_DTF, y = DTF)) + 
  geom_hline(yintercept = mean(xx$DTF), color = &quot;coral&quot;, size = 2) +
  geom_segment(aes(xend = Predicted_DTF, yend = Mean_DTF), alpha = 0.2) +
  geom_point(alpha = 0.5) +
  theme_dblogr() +
  labs(title = &quot;Ne16&quot;, subtitle = t1)
mp2 &lt;- ggplot(xx, aes(x = Predicted_DTF, y = DTF)) + 
  geom_abline(color = &quot;darkorchid&quot;, size = 2) +
  geom_segment(aes(xend = Predicted_DTF, yend = Predicted_DTF), alpha = 0.2) +
  geom_point(alpha = 0.5) +
  theme_dblogr() +
  labs(title = &quot;&quot;, subtitle = t2,
       caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
mp &lt;- ggarrange(mp1, mp2, ncol = 2, align = &quot;h&quot;)
ggsave(&quot;corr_coef_07.png&quot;, mp, width = 8, height = 4)</code></pre>
<p><img src="corr_coef_07.png" /></p>
<div style="page-break-after: always;"></div>
</div>
<div id="effect-of-range" class="section level1">
<h1>Effect of Range</h1>
<p>Another factor to keep in mind, when considering <em>R<sup>2</sup></em>, is the effect of the range of the data.</p>
<pre class="r"><code>x1 &lt;- d1 %&gt;% filter(MacroEnv == &quot;Macroenvironment 1&quot;) %&gt;% mutate(Range = &quot;Low&quot;)
x2 &lt;- x1 %&gt;% mutate(DTF = DTF + 20, DTM = DTM + 20, Range = &quot;High&quot;,
                    MacroEnv = &quot;Macroenvironment 2&quot;)
x3 &lt;- bind_rows(x1, x2) %&gt;% mutate(Range = &quot;Both&quot;)
xx &lt;- bind_rows(x1, x2, x3) %&gt;% 
  mutate(Range = factor(Range, levels = c(&quot;Low&quot;,&quot;High&quot;,&quot;Both&quot;)))
mp &lt;- ggplot(xx, aes(x = DTF, y = DTM)) + 
  geom_point(aes(color = MacroEnv)) + 
  geom_smooth(method = &quot;lm&quot;, se = F) +
  stat_poly_eq(formula = y ~ x, parse = T, rr.digits = 3) +
  facet_grid(.~Range) +
  theme_dblogr(legend.position = &quot;none&quot;) +
  labs(caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
ggsave(&quot;corr_coef_08.png&quot;, mp, width = 6, height = 4)</code></pre>
<pre class="r"><code>ggsave(&quot;../../academic_graphs/correlation_coefficients/gallery/gallery/corr_coef_08.png&quot;, mp, width = 6, height = 4)</code></pre>
<p><img src="corr_coef_08.png" /></p>
<div style="page-break-after: always;"></div>
</div>
<div id="rmse" class="section level1">
<h1>RMSE</h1>
<p>The <em>The Root-Mean-Square Error</em> (<em>RMSE</em>) is a measure of the differences between observed and predicted, or an average deviation of the predicted vs observed values.</p>
<p><span class="math inline">\(RMSE=\frac{\sum (o-p^2}{n}\)</span></p>
<ul>
<li><span class="math inline">\(o\)</span> = Observed value</li>
<li><span class="math inline">\(p\)</span> = Predicted value</li>
<li><span class="math inline">\(n\)</span> = Number of observations</li>
</ul>
<pre class="r"><code># Create RMSE function
modelRMSE &lt;- function(o, p) {
  sqrt(sum((o-p)^2) / (length(o)))
}
# Calculate RMSE for Ro17
xx &lt;- d2 %&gt;% filter(Expt == &quot;Su16&quot;)
modelRMSE(xx$DTF, xx$Predicted_DTF)</code></pre>
<pre><code>## [1] 1.610582</code></pre>
<pre class="r"><code># Calculate RMSE for Ne17
xx &lt;- d2 %&gt;% filter(Expt == &quot;Ne16&quot;)
modelRMSE(xx$DTF, xx$Predicted_DTF)</code></pre>
<pre><code>## [1] 26.4111</code></pre>
<p><strong>interpretation</strong>: the standard deviation of the unexplained variance in <code>Ro17</code> is <code>0.95</code> and in <code>Ne17</code> is <code>24.4</code>.</p>
</div>
<div id="final-plots" class="section level1">
<h1>Final Plots</h1>
<p>Note: for easier interpretation, the <code>x</code> and <code>y</code> axis have been swapped, since <em>overpredictions</em> will be above the <code>geom_abline</code> and <em>underpredictions</em> below.</p>
<pre class="r"><code>my_ggplot &lt;- function(expts, colors) {
  # Prep data
  xx &lt;- d2 %&gt;% filter(Expt %in% expts)
  r2 &lt;- round(SumOfSquaresR2(o = xx$DTF, p = xx$Predicted_DTF), 3)
  rmse &lt;- round(modelRMSE(o = xx$DTF, p = xx$Predicted_DTF), 1)
  mymin &lt;- min(c(xx$DTF, xx$Predicted_DTF))
  mymax &lt;- max(c(xx$DTF, xx$Predicted_DTF))
  # Plot
  ggplot(xx, aes(x = DTF, y = Predicted_DTF)) +
    geom_point(aes(fill = Expt), pch = 21, size = 2, alpha = 0.7) + 
    geom_abline(color = &quot;blue&quot;) + 
    ylim(c(mymin, mymax)) +
    xlim(c(mymin, mymax)) +
    scale_fill_manual(values = colors) +
    theme_dblogr(legend.position = &quot;none&quot;) +
    labs(y = &quot;Predicted DTF&quot;, x = &quot;Observed DTF&quot;,
         title = substitute(
           paste(italic(&quot;R&quot;)^2, &quot; = &quot;, r2, &quot; | &quot;, italic(&quot;RMSE&quot;), &quot; = &quot;, rmse), 
           list(r2 = r2, rmse = rmse)))
}
mp1 &lt;- my_ggplot(&quot;Su16&quot;, &quot;darkgreen&quot;)  + facet_grid(.~Expt)
mp2 &lt;- my_ggplot(&quot;Ne16&quot;, &quot;darkorange&quot;) + facet_grid(.~Expt)
mp3 &lt;- my_ggplot(&quot;It16&quot;, &quot;darkblue&quot;)   + facet_grid(.~Expt) +
  labs(caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
mp &lt;- ggarrange(mp1, mp2, mp3, ncol = 3)
ggsave(&quot;corr_coef_09.png&quot;, mp, width = 10, height = 4)</code></pre>
<p><img src="corr_coef_09.png" /></p>
<pre class="r"><code>mp &lt;- my_ggplot(c(&quot;Su16&quot;,&quot;Ne16&quot;,&quot;It16&quot;), c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) + 
  theme(legend.position = &quot;bottom&quot;)
ggsave(&quot;corr_coef_10.png&quot;, mp, width = 6, height = 4)</code></pre>
<p><img src="corr_coef_10.png" /></p>
<div style="page-break-after: always;"></div>
</div>
<div id="model-evaluation" class="section level1">
<h1>Model Evaluation</h1>
<p>Next we will evaluate a <strong>Photothermal Model</strong> which describes the reciprical of DTF (<code>RDTF</code>) as a linear function of temperature and photoperiod:</p>
<p><span class="math inline">\(\frac{1}{f}=a+b\overline{T}+c\overline{P}\)</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(f\)</span> = Days from sowing to flower (<code>DTF</code>)</li>
<li><span class="math inline">\(\overline{T}\)</span> = Mean temperature (<code>T_mean</code>)</li>
<li><span class="math inline">\(\overline{P}\)</span> = Mean photoperiod (<code>P_mean</code>)</li>
<li><span class="math inline">\(a,b,c\)</span> = Genotype specific constants</li>
</ul>
<pre class="r"><code># Perform linear regression
myModel &lt;- lm(RDTF ~ T_mean + P_mean, data = d1)
summary(myModel)</code></pre>
<pre><code>## 
## Call:
## lm(formula = RDTF ~ T_mean + P_mean, data = d1)
## 
## Residuals:
##        Min         1Q     Median         3Q        Max 
## -0.0038951 -0.0005957 -0.0001821  0.0004946  0.0086038 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -1.843e-02  1.894e-03  -9.730 1.54e-12 ***
## T_mean       7.888e-04  8.688e-05   9.079 1.20e-11 ***
## P_mean       1.761e-03  1.223e-04  14.395  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.002006 on 44 degrees of freedom
## Multiple R-squared:  0.8893, Adjusted R-squared:  0.8843 
## F-statistic: 176.8 on 2 and 44 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>In this case we now have multiple independant varables and cannot correlate <code>RDTF</code> with <code>T_mean</code> + <code>P_mean</code> using <em>Pearson’s</em> formula. Instead we will correlate <code>RDTF</code> with the <code>Predicted_RDTF</code> values that come from the model.</p>
<pre class="r"><code># Get predicted values and residual values from model
d1 &lt;- d1 %&gt;% mutate(Predicted_RDTF =     predict(myModel), 
                    Predicted_DTF  = 1 / predict(myModel),
                    Residuals_RDTF =     residuals(myModel),
                    Residuals_DTF  = abs( (1/DTF) - (1/Predicted_DTF) ))</code></pre>
<p>Calculate <em>R<sup>2</sup></em></p>
<pre class="r"><code># Calculate R^2 using cor function
cor(d1$RDTF, d1$Predicted_RDTF)^2</code></pre>
<pre><code>## [1] 0.8893289</code></pre>
<pre class="r"><code># Calculate R^2 using Pearson&#39;s formula
pearsonsR2(x = d1$RDTF, y = d1$Predicted_RDTF)</code></pre>
<pre><code>## [1] 0.8893289</code></pre>
<pre class="r"><code># Calculate R^2 using SS formula
SumOfSquaresR2(o = d1$RDTF, p = d1$Predicted_RDTF)</code></pre>
<pre><code>## [1] 0.8893289</code></pre>
<p>Each formula gives the same <em>R<sup>2</sup></em> result.</p>
<pre class="r"><code>mp &lt;- ggplot(d1, aes(x = Predicted_RDTF, y = RDTF)) +
  geom_smooth(method = &quot;lm&quot;, se = F, size = 2, color = &quot;red&quot;) +
  geom_abline(color = &quot;blue&quot;) +
  geom_segment(aes(yend = Predicted_RDTF, xend = Predicted_RDTF)) +
  geom_point(aes(fill = MacroEnv, size = abs(Residuals_RDTF)), pch = 21, alpha = 0.7) +
  scale_fill_manual(values = c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;)) +
  theme_dblogr(legend.position = &quot;none&quot;) +
  labs(title = substitute(paste(italic(&quot;R&quot;)^2, &quot; = &quot;, r2), 
         list(r2 = round(SumOfSquaresR2(o = d1$DTF, p = d1$Predicted_DTF), 3))),
       caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
ggsave(&quot;corr_coef_11.png&quot;, mp, width = 6, height = 4)</code></pre>
<p><img src="corr_coef_11.png" /></p>
<p>However, we are interested in <code>DTF</code> and not <code>RDTF</code>. Let see how <em>R<sup>2</sup></em> changes when we calculate it for <code>DTF</code> instead of <code>RDTF</code>.</p>
<pre class="r"><code># Calculate R^2 using cor function
cor(x = d1$DTF, y = d1$Predicted_DTF)^2</code></pre>
<pre><code>## [1] 0.8823158</code></pre>
<pre class="r"><code># Calculate R^2 using Pearson&#39;s formula
pearsonsR2(x = d1$DTF, y = d1$Predicted_DTF)</code></pre>
<pre><code>## [1] 0.8823158</code></pre>
<pre class="r"><code># Calculate R^2 using SS formula
SumOfSquaresR2(o = d1$DTF, p = d1$Predicted_DTF)</code></pre>
<pre><code>## [1] 0.8775759</code></pre>
<p>Notice the how the values of <em>R<sup>2</sup></em> from <code>cor</code> or <code>pearssonR2</code> and <code>SumOfSquaresR2</code> do not match. Why is this occuring?</p>
<pre class="r"><code>mp &lt;- ggplot(d1, aes(y = DTF, x = Predicted_DTF)) +
  geom_smooth(method = &quot;lm&quot;, se = F, size = 2, color = &quot;red&quot;) +
  geom_abline(color = &quot;blue&quot;) + 
  geom_segment(aes(yend = Predicted_DTF, xend = Predicted_DTF)) +
  geom_point(aes(fill = Expt, size = abs(Residuals_DTF)), pch = 21, alpha = 0.7) + 
  theme_dblogr(legend.position = &quot;none&quot;) + 
  labs(title = substitute(paste(italic(&quot;R&quot;)^2, &quot; = &quot;, r2), 
         list(r2 = round(SumOfSquaresR2(o = d1$DTF, p = d1$Predicted_DTF), 3))),
       caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
ggsave(&quot;corr_coef_12.png&quot;, mp, width = 6, height = 4)</code></pre>
<p><img src="corr_coef_12.png" /></p>
<p>Now that we’ve transformed the data, the <code>geom_abline</code> and <code>geom_smooth</code> lines no longer perfectly overlap, which causes the slight difference in <em>R<sup>2</sup></em>.</p>
<p>However, this still leaves open the questions of why <code>geom_abline()</code> and <code>geom_smooth</code> no longer overlap after transforming the data? Lets try and visualize this with test data.</p>
<pre class="r"><code># Prep data
xx &lt;- data.frame(x = 1:10, y = 1:10 + 0.5) %&gt;% 
  mutate(Residuals = abs(y-x))
SSt &lt;- sum((xx$x - mean(xx$x))^2)
SSr &lt;- sum((xx$x - xx$y)^2)
r2 &lt;- round(1 - SSr / SSt, 4)
# Plot
mp1 &lt;- ggplot(xx, aes(x = x, y = y)) + 
  geom_abline() + 
  geom_segment(aes(xend = x, yend = x)) +
  geom_point(aes(size = Residuals), alpha = 0.7) +
  theme_dblogr() +
  labs(title = substitute(paste(italic(&quot;R&quot;)^2, &quot; = 1 - (&quot;, SSr, &quot;/&quot;,SSt, &quot;) = &quot;, r2 ), 
         list(SSr = SSr, SSt = SSt, r2 = r2)))
# Prep data
xx &lt;- xx %&gt;% mutate(Residuals = abs((1/y)-(1/x)))
SSt &lt;- sum((1 / xx$x - mean(1 / xx$x))^2)
SSr &lt;- sum((1 / xx$x - 1 / xx$y)^2)
r2 &lt;- round(1 - SSr / SSt, 4)
# Plot
mp2 &lt;- ggplot(xx, aes(x = 1 / x, y = 1 / y)) + 
  geom_abline() +
  geom_segment(aes(xend = 1 / x, yend = 1 / x)) +
  geom_point(aes(size = Residuals), alpha = 0.7) +
  theme_dblogr() +
  labs(title = substitute(paste(italic(&quot;R&quot;)^2, &quot; = 1 - (&quot;, SSr, &quot;/&quot;,SSt, &quot;) = &quot;, r2 ), 
         list(SSr = round(SSr, 3), SSt = round(SSt, 3), r2 = r2)),
       caption = &quot;\xa9 www.dblogr.com/  |  Data: AGILE&quot;)
# Append Plots
mp &lt;- ggarrange(mp1, mp2, ncol = 2, legend = &quot;none&quot;, align = &quot;h&quot;)
ggsave(&quot;corr_coef_13.png&quot;, mp, width = 8, height = 4)</code></pre>
<p><img src="corr_coef_13.png" /></p>
<p>Visualizing the Photothermal model</p>
<pre class="r"><code>x &lt;- d1$T_mean
y &lt;- d1$P_mean
z &lt;- d1$RDTF
cv &lt;- as.numeric(as.factor(d1$MacroEnv))
fit &lt;- lm(z ~ x + y)
# Create PhotoThermal plane
fitpoints &lt;- predict(fit)
grid.lines = 12
x.pred &lt;- seq(min(x), max(x), length.out = grid.lines)
y.pred &lt;- seq(min(y), max(y), length.out = grid.lines)
xy &lt;- expand.grid(x = x.pred, y = y.pred)
z.pred &lt;- matrix(predict(fit, newdata = xy), 
                 nrow = grid.lines, ncol = grid.lines)
# Plot with regression plane
png(&quot;corr_coef_14.png&quot;, width = 1000, height = 1000, res = 200)
par(mar=c(1.5, 2.5, 1.5, 0.5))
plot3D::scatter3D(x, y, z, pch = 18, cex = 2, zlim = c(0.005,0.03),
  col = alpha(c(&quot;darkgreen&quot;,&quot;darkorange&quot;,&quot;darkblue&quot;),0.5), 
  colvar = cv, colkey = F, col.grid = &quot;grey&quot;, bty = &quot;u&quot;,
  theta = 40, phi = 25, ticktype = &quot;detailed&quot;, cex.lab = 1, cex.axis = 0.5,
  xlab = &quot;Temperature&quot;, ylab = &quot;Photoperiod&quot;, zlab = &quot;1 / DTF&quot;,
  surf = list(x = x.pred, y = y.pred, z = z.pred, col = &quot;black&quot;, 
  facets = NA, fit = fitpoints), main = &quot;PhotoThermal Model&quot;)
dev.off()</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p><img src="corr_coef_14.png" /></p>
</div>
